{% extends "base.html" %}

<!-- Enhanced UI with separate submit buttons for SQL and PowerShell jobs -->
{% block title %}Create Job - Windows Job Scheduler{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="fas fa-plus me-2"></i>Create New Job</h4>
            </div>
            <div class="card-body">
                <form id="createJobForm">
                    <!-- Job Type Selection -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Job Type *</label>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card job-type-card" data-type="sql" onclick="selectJobType('sql')">
                                    <div class="card-body text-center">
                                        <i class="fas fa-database fa-3x text-info mb-3"></i>
                                        <h5>SQL Job</h5>
                                        <p class="text-muted mb-0">Execute SQL queries on SQL Server databases</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card job-type-card" data-type="powershell" onclick="selectJobType('powershell')">
                                    <div class="card-body text-center">
                                        <i class="fab fa-microsoft fa-3x text-primary mb-3"></i>
                                        <h5>PowerShell Job</h5>
                                        <p class="text-muted mb-0">Run PowerShell scripts and commands</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card job-type-card" data-type="agent" onclick="selectJobType('agent')">
                                    <div class="card-body text-center">
                                        <i class="fas fa-server fa-3x text-success mb-3"></i>
                                        <h5>Agent Job</h5>
                                        <p class="text-muted mb-0">Execute jobs on remote agents with distributed processing</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="jobType" name="type" required>
                    </div>

                    <!-- Basic Information -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="jobName" class="form-label">Job Name *</label>
                            <input type="text" class="form-control" id="jobName" name="name" required 
                                   placeholder="Enter a descriptive name for your job">
                            <div class="form-text">Use a clear, descriptive name (e.g., "Daily Sales Report")</div>
                        </div>
                        <div class="col-md-4">
                            <label for="jobEnabled" class="form-label">Status</label>
                            <select class="form-select" id="jobEnabled" name="enabled">
                                <option value="true" selected>Enabled</option>
                                <option value="false">Disabled</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="jobDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="jobDescription" name="description" rows="2" 
                                  placeholder="Optional description of what this job does"></textarea>
                    </div>

                    <!-- SQL Job Configuration -->
                    <div id="sqlJobConfig" class="job-config" style="display: none;">
                        <h5 class="mb-3"><i class="fas fa-database me-2"></i>SQL Configuration</h5>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <label for="connectionName" class="form-label">Database Connection *</label>
                                <a href="{{ url_for('connections') }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                    <i class="fas fa-plus me-1"></i>Manage Connections
                                </a>
                            </div>
                            <select class="form-select" id="connectionName" name="connection_name" required>
                                <option value="" disabled selected>Loading connections...</option>
                            </select>
                            <div class="form-text">Select the database connection to use for this SQL job</div>
                        </div>

                        <!-- Custom Connection Details (hidden by default) -->
                        <div id="customConnectionSection" style="display: none;">
                            <div class="card bg-light">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-database me-1"></i>Custom Database Connection</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="customServer" class="form-label">Server</label>
                                            <input type="text" class="form-control" id="customServer" 
                                                   placeholder="localhost or server.domain.com">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="customPort" class="form-label">Port</label>
                                            <input type="number" class="form-control" id="customPort" 
                                                   value="1433" min="1" max="65535">
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <label for="customDatabase" class="form-label">Database</label>
                                            <input type="text" class="form-control" id="customDatabase" 
                                                   placeholder="Database name">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="customAuthType" class="form-label">Authentication</label>
                                            <select class="form-select" id="customAuthType">
                                                <option value="sql" selected>SQL Server Authentication</option>
                                                <option value="windows">Windows Authentication</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- SQL Authentication fields -->
                                    <div id="sqlAuthFields" style="display: none;">
                                        <div class="row mt-3">
                                            <div class="col-md-6">
                                                <label for="customUsername" class="form-label">Username</label>
                                                <input type="text" class="form-control" id="customUsername" 
                                                       placeholder="SQL Server username">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="customPassword" class="form-label">Password</label>
                                                <input type="password" class="form-control" id="customPassword" 
                                                       placeholder="SQL Server password">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <button type="button" class="btn btn-outline-info" onclick="testCustomConnection()">
                                            <i class="fas fa-plug me-1"></i>Test Connection
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="sqlQuery" class="form-label">SQL Query *</label>
                            <textarea class="form-control" id="sqlQuery" name="sql_query" rows="8" 
                                      placeholder="Enter your SQL query here...&#10;&#10;Example:&#10;SELECT COUNT(*) as total_orders&#10;FROM orders&#10;WHERE created_date >= DATEADD(day, -1, GETDATE())"></textarea>
                            <div class="form-text">Enter the SQL query to execute. Only SELECT statements are recommended for safety.</div>
                        </div>

                        <!-- Remove Query Timeout and Max Rows as per user request -->
                    </div>

                    <!-- PowerShell Job Configuration -->
                    <div id="powershellJobConfig" class="job-config" style="display: none;">
                        <h5 class="mb-3"><i class="fab fa-microsoft me-2"></i>PowerShell Configuration</h5>
                        
                        <div class="mb-3">
                            <label class="form-label">Script Type</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="scriptType" id="scriptTypeInline" value="inline" checked>
                                <label class="btn btn-outline-primary" for="scriptTypeInline">
                                    <i class="fas fa-edit me-1"></i>Inline Script
                                </label>
                                
                                <input type="radio" class="btn-check" name="scriptType" id="scriptTypeFile" value="file">
                                <label class="btn btn-outline-primary" for="scriptTypeFile">
                                    <i class="fas fa-file me-1"></i>Script File
                                </label>
                            </div>
                        </div>

                        <div id="inlineScriptSection">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label for="scriptContent" class="form-label mb-0">PowerShell Script *</label>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-secondary" onclick="expandScriptEditor()">
                                            <i class="fas fa-expand-arrows-alt"></i> Expand
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="formatScript()">
                                            <i class="fas fa-code"></i> Format
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="insertTemplate()">
                                            <i class="fas fa-file-code"></i> Template
                                        </button>
                                    </div>
                                </div>
                                <textarea class="form-control font-monospace" id="scriptContent" name="script_content" rows="15" 
                                          style="resize: vertical; min-height: 300px;"
                                          placeholder="Enter your PowerShell script here...&#10;&#10;Example:&#10;Write-Host 'Starting script execution...'&#10;$startTime = Get-Date&#10;Write-Host 'Current time: $startTime'&#10;# Your PowerShell commands here&#10;Write-Host 'Script completed successfully!'"></textarea>
                                <div class="form-text">
                                    <small><strong>Tips:</strong> Use Ctrl+A to select all, supports multi-line scripts with proper formatting preservation. 
                                    The script will be executed exactly as written, preserving all formatting, comments, and line breaks.</small>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <span id="scriptLineCount">Lines: 0</span> | 
                                        <span id="scriptCharCount">Characters: 0</span>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div id="fileScriptSection" style="display: none;">
                            <div class="mb-3">
                                <label for="scriptPath" class="form-label">Script File Path *</label>
                                <input type="text" class="form-control" id="scriptPath" name="script_path" 
                                       placeholder="C:\Scripts\MyScript.ps1">
                                <div class="form-text">Full path to the PowerShell script file (.ps1)</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <label for="executionPolicy" class="form-label">Execution Policy</label>
                                <select class="form-select" id="executionPolicy" name="execution_policy">
                                    <option value="RemoteSigned" selected>RemoteSigned</option>
                                    <option value="Unrestricted">Unrestricted</option>
                                    <option value="Bypass">Bypass</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="workingDirectory" class="form-label">Working Directory</label>
                                <input type="text" class="form-control" id="workingDirectory" name="working_directory" 
                                       placeholder="C:\Scripts (optional)">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="scriptParameters" class="form-label">Parameters</label>
                            <input type="text" class="form-control" id="scriptParameters" name="parameters" 
                                   placeholder="-Message 'Hello World' -Verbose">
                            <div class="form-text">Space-separated parameters to pass to the script</div>
                        </div>
                    </div>

                    <!-- Schedule Configuration -->
                    <div class="mt-4">
                        <h5 class="mb-3"><i class="fas fa-calendar-alt me-2"></i>Schedule Configuration</h5>
                        
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enableSchedule">
                                <label class="form-check-label" for="enableSchedule">
                                    Enable Scheduling
                                </label>
                            </div>
                        </div>

                        <div id="scheduleConfig" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Schedule Type</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="scheduleType" id="scheduleTypeCron" value="cron" checked>
                                    <label class="btn btn-outline-secondary" for="scheduleTypeCron">
                                        <i class="fas fa-clock me-1"></i>Cron Expression
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="scheduleType" id="scheduleTypeInterval" value="interval">
                                    <label class="btn btn-outline-secondary" for="scheduleTypeInterval">
                                        <i class="fas fa-redo me-1"></i>Interval
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="scheduleType" id="scheduleTypeOnce" value="once">
                                    <label class="btn btn-outline-secondary" for="scheduleTypeOnce">
                                        <i class="fas fa-calendar-day me-1"></i>One Time
                                    </label>
                                </div>
                            </div>

                            <!-- Timezone Selection -->
                            <div class="mb-3">
                                <label for="scheduleTimezone" class="form-label">
                                    <i class="fas fa-globe me-1"></i>Schedule Timezone
                                </label>
                                <select class="form-select" id="scheduleTimezone" name="schedule_timezone">
                                    <option value="UTC" selected>UTC (Coordinated Universal Time)</option>
                                    <optgroup label="America">
                                        <option value="America/New_York">America/New_York (Eastern Time)</option>
                                        <option value="America/Chicago">America/Chicago (Central Time)</option>
                                        <option value="America/Denver">America/Denver (Mountain Time)</option>
                                        <option value="America/Los_Angeles">America/Los_Angeles (Pacific Time)</option>
                                        <option value="America/Phoenix">America/Phoenix (MST - No DST)</option>
                                        <option value="America/Anchorage">America/Anchorage (Alaska Time)</option>
                                        <option value="America/Toronto">America/Toronto (Eastern Canada)</option>
                                        <option value="America/Vancouver">America/Vancouver (Pacific Canada)</option>
                                        <option value="America/Mexico_City">America/Mexico_City (CST)</option>
                                        <option value="America/Sao_Paulo">America/Sao_Paulo (Brazil)</option>
                                    </optgroup>
                                    <optgroup label="Europe">
                                        <option value="Europe/London">Europe/London (GMT/BST)</option>
                                        <option value="Europe/Paris">Europe/Paris (CET/CEST)</option>
                                        <option value="Europe/Berlin">Europe/Berlin (CET/CEST)</option>
                                        <option value="Europe/Rome">Europe/Rome (CET/CEST)</option>
                                        <option value="Europe/Madrid">Europe/Madrid (CET/CEST)</option>
                                        <option value="Europe/Amsterdam">Europe/Amsterdam (CET/CEST)</option>
                                        <option value="Europe/Stockholm">Europe/Stockholm (CET/CEST)</option>
                                        <option value="Europe/Moscow">Europe/Moscow (MSK)</option>
                                    </optgroup>
                                    <optgroup label="Asia">
                                        <option value="Asia/Tokyo">Asia/Tokyo (JST)</option>
                                        <option value="Asia/Shanghai">Asia/Shanghai (CST)</option>
                                        <option value="Asia/Hong_Kong">Asia/Hong_Kong (HKT)</option>
                                        <option value="Asia/Singapore">Asia/Singapore (SGT)</option>
                                        <option value="Asia/Kolkata">Asia/Kolkata (IST)</option>
                                        <option value="Asia/Dubai">Asia/Dubai (GST)</option>
                                        <option value="Asia/Seoul">Asia/Seoul (KST)</option>
                                        <option value="Asia/Bangkok">Asia/Bangkok (ICT)</option>
                                    </optgroup>
                                    <optgroup label="Pacific">
                                        <option value="Australia/Sydney">Australia/Sydney (AEST/AEDT)</option>
                                        <option value="Australia/Melbourne">Australia/Melbourne (AEST/AEDT)</option>
                                        <option value="Australia/Perth">Australia/Perth (AWST)</option>
                                        <option value="Pacific/Auckland">Pacific/Auckland (NZST/NZDT)</option>
                                        <option value="Pacific/Honolulu">Pacific/Honolulu (HST)</option>
                                    </optgroup>
                                </select>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    All schedules are stored in UTC. Local times are converted automatically with DST handling.
                                    <div id="timezoneInfo" class="mt-1 text-primary"></div>
                                </div>
                            </div>

                            <div id="cronSchedule" class="schedule-section">
                                <div class="mb-3">
                                    <label for="cronExpression" class="form-label">Cron Expression</label>
                                    <input type="text" class="form-control" id="cronExpression" name="cron_expression" 
                                           placeholder="0 0 12 * * ?" value="0 0 12 * * ?">
                                    <div class="form-text">Format: second minute hour day month day_of_week</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Quick Presets</label>
                                    <div class="btn-group-vertical w-100">
                                        <button type="button" class="btn btn-outline-info btn-sm" onclick="setCronPreset('0 0 9 * * 1-5')">Daily at 9 AM (Weekdays)</button>
                                        <button type="button" class="btn btn-outline-info btn-sm" onclick="setCronPreset('0 0 0 * * 0')">Weekly (Sunday Midnight)</button>
                                        <button type="button" class="btn btn-outline-info btn-sm" onclick="setCronPreset('0 0 0 1 * ?')">Monthly (1st of Month)</button>
                                        <button type="button" class="btn btn-outline-info btn-sm" onclick="setCronPreset('0 */15 * * * ?')">Every 15 Minutes</button>
                                    </div>
                                </div>
                            </div>

                            <div id="intervalSchedule" class="schedule-section" style="display: none;">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label for="intervalDays" class="form-label">Days</label>
                                        <input type="number" class="form-control" id="intervalDays" min="0" value="0">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="intervalHours" class="form-label">Hours</label>
                                        <input type="number" class="form-control" id="intervalHours" min="0" max="23" value="0">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="intervalMinutes" class="form-label">Minutes</label>
                                        <input type="number" class="form-control" id="intervalMinutes" min="0" max="59" value="30">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="intervalSeconds" class="form-label">Seconds</label>
                                        <input type="number" class="form-control" id="intervalSeconds" min="0" max="59" value="0">
                                    </div>
                                </div>
                            </div>

                            <div id="onceSchedule" class="schedule-section" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="runDate" class="form-label">Run Date</label>
                                        <input type="date" class="form-control" id="runDate">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="runTime" class="form-label">Run Time</label>
                                        <input type="time" class="form-control" id="runTime">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Options -->
                    <div class="mt-4">
                        <div class="d-flex align-items-center mb-3">
                            <h5 class="mb-0 me-2"><i class="fas fa-cog me-2"></i>Advanced Options</h5>
                            <button type="button" class="btn btn-link btn-sm" data-bs-toggle="collapse" data-bs-target="#advancedOptions">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        
                        <div class="collapse" id="advancedOptions">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="timeout" class="form-label">Timeout (seconds)</label>
                                    <input type="number" class="form-control" id="timeout" name="timeout" 
                                           value="300" min="1" max="3600">
                                </div>
                                <div class="col-md-4">
                                    <label for="maxRetries" class="form-label">Max Retries</label>
                                    <input type="number" class="form-control" id="maxRetries" name="max_retries" 
                                           value="3" min="0" max="10">
                                </div>
                                <div class="col-md-4">
                                    <label for="retryDelay" class="form-label">Retry Delay (seconds)</label>
                                    <input type="number" class="form-control" id="retryDelay" name="retry_delay" 
                                           value="60" min="1" max="3600">
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <label for="runAs" class="form-label">Run As User</label>
                                <input type="text" class="form-control" id="runAs" name="run_as" 
                                       placeholder="DOMAIN\username (optional)">
                                <div class="form-text">Windows domain account to run the job as (optional)</div>
                            </div>
                        </div>
                    </div>

                    <!-- SQL Job Action Buttons -->
                    <div id="sqlJobActions" class="mt-4 pt-3 border-top sql-job-actions" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-secondary me-2" onclick="validateJob()">
                                    <i class="fas fa-check me-1"></i>Validate SQL
                                </button>
                                <button type="button" class="btn btn-outline-info me-2" onclick="testConnection()">
                                    <i class="fas fa-plug me-1"></i>Test Connection
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="debugFormData()">
                                    <i class="fas fa-bug me-1"></i>Debug SQL Data
                                </button>
                            </div>
                            <div class="col-md-6 text-end">
                                <a href="{{ url_for('job_list') }}" class="btn btn-secondary me-3">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </a>
                                <button type="submit" class="btn btn-info btn-lg sql-submit-btn">
                                    <i class="fas fa-database me-2"></i>Create SQL Job
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- PowerShell Job Action Buttons -->
                    <div id="powershellJobActions" class="mt-4 pt-3 border-top powershell-job-actions" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-secondary me-2" onclick="validateJob()">
                                    <i class="fas fa-check me-1"></i>Validate PowerShell
                                </button>
                                <button type="button" class="btn btn-outline-warning me-2" onclick="testPowerShellScript()">
                                    <i class="fab fa-microsoft me-1"></i>Test Script Syntax
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="debugPowerShellData()">
                                    <i class="fas fa-bug me-1"></i>Debug PowerShell Data
                                </button>
                            </div>
                            <div class="col-md-6 text-end">
                                <a href="{{ url_for('job_list') }}" class="btn btn-secondary me-3">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </a>
                                <button type="button" class="btn btn-primary btn-lg powershell-submit-btn" onclick="showPowerShellJobJson()">
                                    <i class="fab fa-microsoft me-2"></i>Create PowerShell Job
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Agent Job Configuration -->
                    <div id="agentJobConfig" class="job-config" style="display: none;">
                        <h5 class="mb-3"><i class="fas fa-server me-2"></i>Agent Job Configuration</h5>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="agentPool" class="form-label">Agent Pool *</label>
                                <select class="form-select" id="agentPool" name="agent_pool" required>
                                    <option value="" disabled selected>Loading agent pools...</option>
                                </select>
                                <div class="form-text">Select the agent pool where this job should execute</div>
                            </div>
                            <div class="col-md-6">
                                <label for="executionStrategy" class="form-label">Execution Strategy *</label>
                                <select class="form-select" id="executionStrategy" name="execution_strategy" onchange="toggleExecutionOptions()">
                                    <option value="default_pool">Default Pool - Single execution</option>
                                    <option value="multi_configuration">Multi-Configuration - Parallel configurations</option>
                                    <option value="multi_agent">Multi-Agent - Same job on multiple agents</option>
                                </select>
                            </div>
                        </div>

                        <!-- Agent Requirements -->
                        <div class="mb-3">
                            <label for="agentCapabilities" class="form-label">Required Capabilities</label>
                            <input type="text" class="form-control" id="agentCapabilities" name="agent_capabilities" 
                                   placeholder="python,docker,git (comma-separated)">
                            <div class="form-text">Specify required agent capabilities (optional)</div>
                        </div>

                        <!-- Multi-Configuration Options -->
                        <div id="multiConfigOptions" style="display: none;">
                            <div class="card bg-light mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-list me-1"></i>Multi-Configuration Settings</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="maxParallelConfigs" class="form-label">Max Parallel Configurations</label>
                                            <input type="number" class="form-control" id="maxParallelConfigs" 
                                                   name="max_parallel" value="3" min="1" max="10">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="configTimeout" class="form-label">Timeout per Configuration (minutes)</label>
                                            <input type="number" class="form-control" id="configTimeout" 
                                                   name="config_timeout" value="30" min="1" max="480">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="configurations" class="form-label">Configurations (JSON)</label>
                                        <textarea class="form-control" id="configurations" name="configurations" rows="4" 
                                                  placeholder='[{"env": "dev", "database": "dev_db"}, {"env": "prod", "database": "prod_db"}]'></textarea>
                                        <div class="form-text">Define configurations as JSON array</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Multi-Agent Options -->
                        <div id="multiAgentOptions" style="display: none;">
                            <div class="card bg-light mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-server me-1"></i>Multi-Agent Settings</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="agentCount" class="form-label">Number of Agents</label>
                                            <input type="number" class="form-control" id="agentCount" 
                                                   name="agent_count" value="2" min="1" max="20">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="distributionStrategy" class="form-label">Distribution Strategy</label>
                                            <select class="form-select" id="distributionStrategy" name="distribution">
                                                <option value="round_robin">Round Robin</option>
                                                <option value="random">Random</option>
                                                <option value="least_loaded">Least Loaded</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Job Steps -->
                        <div class="mb-3">
                            <label for="agentJobSteps" class="form-label">Job Steps (YAML) *</label>
                            <textarea class="form-control" id="agentJobSteps" name="job_steps" rows="8" required 
                                      placeholder="job_steps:
  - name: checkout_code
    type: git_checkout
    repository: 'https://github.com/company/app.git'
    branch: 'main'
    
  - name: build_application  
    type: shell_command
    command: 'docker build -t myapp .'
    
  - name: run_tests
    type: shell_command
    command: 'docker run --rm myapp npm test'"></textarea>
                            <div class="form-text">Define the steps to execute on the agent(s)</div>
                        </div>

                        <!-- Advanced Options -->
                        <div class="card bg-light">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-cog me-1"></i>Advanced Options</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="agentTimeout" class="form-label">Timeout (minutes)</label>
                                        <input type="number" class="form-control" id="agentTimeout" 
                                               name="timeout_minutes" value="60" min="1" max="1440">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="agentPriority" class="form-label">Priority</label>
                                        <select class="form-select" id="agentPriority" name="priority">
                                            <option value="1">1 - Lowest</option>
                                            <option value="3">3 - Low</option>
                                            <option value="5" selected>5 - Normal</option>
                                            <option value="7">7 - High</option>
                                            <option value="10">10 - Highest</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="agentRetries" class="form-label">Max Retries</label>
                                        <input type="number" class="form-control" id="agentRetries" 
                                               name="max_retries" value="0" min="0" max="5">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Agent Job Action Buttons -->
                    <div id="agentJobActions" class="mt-4 pt-3 border-top agent-job-actions" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <a href="/agents" class="btn btn-outline-success" target="_blank">
                                    <i class="fas fa-server me-1"></i>Manage Agents
                                </a>
                            </div>
                            <div class="col-md-6 text-end">
                                <a href="{{ url_for('job_list') }}" class="btn btn-secondary me-3">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </a>
                                <button type="button" class="btn btn-success btn-lg agent-submit-btn" onclick="createAgentJob()">
                                    <i class="fas fa-server me-2"></i>Create Agent Job
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Default Action Buttons (when no job type selected) -->
                    <div id="defaultJobActions" class="mt-4 pt-3 border-top">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Please select a job type above to see available actions
                                </p>
                            </div>
                            <div class="col-md-6 text-end">
                                <a href="{{ url_for('job_list') }}" class="btn btn-secondary">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .job-type-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .job-type-card:hover {
        border-color: var(--secondary-color);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        transform: translateY(-2px);
    }
    
    .job-type-card.selected {
        border-color: var(--secondary-color);
        background-color: rgba(52, 152, 219, 0.1);
    }
    
    .job-config {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        border-left: 4px solid var(--secondary-color);
    }
    
    .schedule-section {
        background-color: white;
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid #dee2e6;
    }
    
    /* Job-specific action sections */
    .sql-job-actions {
        background: linear-gradient(135deg, rgba(23, 162, 184, 0.05), rgba(23, 162, 184, 0.1));
        border-radius: 10px;
        padding: 1.5rem;
        border: 1px solid rgba(23, 162, 184, 0.2);
    }
    
    .powershell-job-actions {
        background: linear-gradient(135deg, rgba(0, 123, 255, 0.05), rgba(0, 123, 255, 0.1));
        border-radius: 10px;
        padding: 1.5rem;
        border: 1px solid rgba(0, 123, 255, 0.2);
    }
    
    /* Enhanced submit buttons */
    .sql-submit-btn {
        box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
        transition: all 0.3s ease;
        font-weight: 600;
        letter-spacing: 0.5px;
    }
    
    .sql-submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(23, 162, 184, 0.4);
    }
    
    .powershell-submit-btn {
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        transition: all 0.3s ease;
        font-weight: 600;
        letter-spacing: 0.5px;
    }
    
    .powershell-submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 123, 255, 0.4);
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    let selectedJobType = null;
    
    // Show PowerShell job JSON configuration
    function showPowerShellJobJson() {
        if (!validateJob()) {
            return;
        }
        
        // Prepare form data
        const formData = new FormData(document.getElementById('createJobForm'));
        const jobData = {
            type: 'powershell',
            name: formData.get('name'),
            description: formData.get('description'),
            enabled: formData.get('enabled') === 'true',
            timeout: parseInt(formData.get('timeout')),
            max_retries: parseInt(formData.get('max_retries')),
            retry_delay: parseInt(formData.get('retry_delay')),
            run_as: formData.get('run_as')
        };
        
        // Add PowerShell-specific data
        const scriptType = document.querySelector('input[name="scriptType"]:checked').value;
        if (scriptType === 'inline') {
            jobData.script_content = formData.get('script_content');
        } else {
            jobData.script_path = formData.get('script_path');
        }
        jobData.execution_policy = formData.get('execution_policy');
        jobData.working_directory = formData.get('working_directory');
        
        // Parse parameters
        const params = formData.get('parameters');
        if (params) {
            jobData.parameters = params.split(' ').filter(p => p.trim());
        }
        
        // Add schedule if enabled
        if (document.getElementById('enableSchedule').checked) {
            const scheduleType = document.querySelector('input[name="scheduleType"]:checked').value;
            const timezone = document.getElementById('scheduleTimezone').value;
            
            if (scheduleType === 'cron') {
                jobData.schedule = {
                    type: 'cron',
                    cron: document.getElementById('cronExpression').value,
                    timezone: timezone
                };
            } else if (scheduleType === 'interval') {
                jobData.schedule = {
                    type: 'interval',
                    interval: {
                        days: parseInt(document.getElementById('intervalDays').value),
                        hours: parseInt(document.getElementById('intervalHours').value),
                        minutes: parseInt(document.getElementById('intervalMinutes').value),
                        seconds: parseInt(document.getElementById('intervalSeconds').value)
                    },
                    timezone: timezone
                };
            } else if (scheduleType === 'once') {
                const date = document.getElementById('runDate').value;
                const time = document.getElementById('runTime').value;
                const localDateTime = `${date}T${time}:00`;
                
                // Convert to UTC if timezone is not UTC
                let utcDateTime = localDateTime;
                if (timezone !== 'UTC') {
                    try {
                        // Create date in specified timezone and convert to UTC
                        const tempDate = new Date(localDateTime);
                        const utcTime = new Date(tempDate.toLocaleString('en-US', { timeZone: 'UTC' }));
                        const localTime = new Date(tempDate.toLocaleString('en-US', { timeZone: timezone }));
                        const offset = localTime.getTime() - utcTime.getTime();
                        const utcDate = new Date(tempDate.getTime() - offset);
                        utcDateTime = utcDate.toISOString().slice(0, 19);
                    } catch (error) {
                        console.warn('Timezone conversion failed, using local time:', error);
                    }
                }
                
                jobData.schedule = {
                    type: 'date',
                    run_date: utcDateTime,
                    timezone: timezone,
                    local_time: localDateTime // Keep original for reference
                };
            }
        }
        
        // Show JSON configuration in popup
        const jsonConfig = JSON.stringify(jobData, null, 2);
        const confirmed = confirm(`PowerShell Job Configuration:\n\n${jsonConfig}\n\nDo you want to save this job?`);
        
        if (confirmed) {
            // Proceed with actual form submission
            submitPowerShellJob(jobData);
        }
    }
    
    // Submit PowerShell job to API
    function submitPowerShellJob(jobData) {
        showLoading();
        
        fetch('/api/jobs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(jobData)
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showSuccess(data.message || 'PowerShell job created successfully!');
                setTimeout(() => {
                    window.location.href = `/jobs/${data.job_id}`;
                }, 2000);
            } else {
                showError(data.error || 'Failed to create PowerShell job');
            }
        })
        .catch(error => {
            hideLoading();
            showError('Error creating PowerShell job: ' + error.message);
        });
    }
    
    // Job type selection
    function selectJobType(type) {
        selectedJobType = type;
        document.getElementById('jobType').value = type;
        
        // Update UI
        document.querySelectorAll('.job-type-card').forEach(card => {
            card.classList.remove('selected');
        });
        document.querySelector(`[data-type="${type}"]`).classList.add('selected');
        
        // Show/hide config sections
        document.querySelectorAll('.job-config').forEach(config => {
            config.style.display = 'none';
        });
        document.getElementById(`${type}JobConfig`).style.display = 'block';
        
        // Show/hide appropriate action sections
        document.getElementById('defaultJobActions').style.display = 'none';
        document.getElementById('sqlJobActions').style.display = 'none';
        document.getElementById('powershellJobActions').style.display = 'none';
        
        if (type === 'sql') {
            document.getElementById('sqlJobActions').style.display = 'block';
        } else if (type === 'powershell') {
            document.getElementById('powershellJobActions').style.display = 'block';
        }
    }
    
    // Script type toggle for PowerShell jobs
    document.querySelectorAll('input[name="scriptType"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'inline') {
                document.getElementById('inlineScriptSection').style.display = 'block';
                document.getElementById('fileScriptSection').style.display = 'none';
                document.getElementById('scriptContent').required = true;
                document.getElementById('scriptPath').required = false;
            } else {
                document.getElementById('inlineScriptSection').style.display = 'none';
                document.getElementById('fileScriptSection').style.display = 'block';
                document.getElementById('scriptContent').required = false;
                document.getElementById('scriptPath').required = true;
            }
        });
    });
    
    // Schedule configuration toggle
    document.getElementById('enableSchedule').addEventListener('change', function() {
        document.getElementById('scheduleConfig').style.display = this.checked ? 'block' : 'none';
    });
    
    // Schedule type selection
    document.querySelectorAll('input[name="scheduleType"]').forEach(radio => {
        radio.addEventListener('change', function() {
            document.querySelectorAll('.schedule-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(`${this.value}Schedule`).style.display = 'block';
        });
    });
    
    // Cron preset functions
    function setCronPreset(expression) {
        document.getElementById('cronExpression').value = expression;
    }
    
    // Set default run date/time for one-time schedule
    function setDefaultDateTime() {
        const now = new Date();
        now.setHours(now.getHours() + 1); // Default to 1 hour from now
        
        const date = now.toISOString().split('T')[0];
        const time = now.toTimeString().slice(0, 5);
        
        document.getElementById('runDate').value = date;
        document.getElementById('runTime').value = time;
    }
    
    // Initialize default date/time when one-time schedule is selected
    document.getElementById('scheduleTypeOnce').addEventListener('change', function() {
        if (this.checked) {
            setDefaultDateTime();
        }
    });
    
    // Form validation
    function validateJob() {
        const form = document.getElementById('createJobForm');
        const formData = new FormData(form);
        
        // Basic validation
        if (!selectedJobType) {
            showError('Please select a job type');
            return false;
        }
        
        if (!formData.get('name')) {
            showError('Job name is required');
            return false;
        }
        
        // Job-specific validation
        if (selectedJobType === 'sql') {
            if (!formData.get('sql_query')) {
                showError('SQL query is required');
                return false;
            }
            if (!formData.get('connection_name')) {
                showError('Database connection is required');
                return false;
            }
        } else if (selectedJobType === 'powershell') {
            const scriptType = document.querySelector('input[name="scriptType"]:checked').value;
            if (scriptType === 'inline' && !formData.get('script_content')) {
                showError('PowerShell script content is required');
                return false;
            } else if (scriptType === 'file' && !formData.get('script_path')) {
                showError('PowerShell script path is required');
                return false;
            }
        }
        
        showSuccess('Job configuration is valid');
        return true;
    }
    
    // Test database connection (for SQL jobs)
    function testConnection() {
        if (selectedJobType !== 'sql') {
            showError('Connection testing is only available for SQL jobs');
            return;
        }
        
        const connectionName = document.getElementById('connectionName').value;
        if (!connectionName) {
            showError('Please select a connection to test');
            return;
        }
        
        showLoading();
        
        // Test the selected connection via API
        fetch(`/api/connections/${connectionName}/test`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                const message = `Connection test successful${data.response_time ? ` (${data.response_time.toFixed(2)}s)` : ''}`;
                showSuccess(message);
            } else {
                showError(`Connection test failed: ${data.error || 'Unknown error'}`);
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Connection test error:', error);
            showError('Connection test failed: ' + error.message);
        });
    }
    
    // Form submission
    document.getElementById('createJobForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!validateJob()) {
            return;
        }
        
        showLoading();
        
        // Prepare form data
        const formData = new FormData(this);
        const jobData = {
            type: selectedJobType,
            name: formData.get('name'),
            description: formData.get('description'),
            enabled: formData.get('enabled') === 'true',
            timeout: parseInt(formData.get('timeout')),
            max_retries: parseInt(formData.get('max_retries')),
            retry_delay: parseInt(formData.get('retry_delay')),
            run_as: formData.get('run_as')
        };
        
        // Add job-specific data
        if (selectedJobType === 'sql') {
            jobData.sql_query = formData.get('sql_query');
            jobData.connection_name = formData.get('connection_name');
            // Remove query_timeout and max_rows as requested
        } else if (selectedJobType === 'powershell') {
            const scriptType = document.querySelector('input[name="scriptType"]:checked').value;
            if (scriptType === 'inline') {
                jobData.script_content = formData.get('script_content');
            } else {
                jobData.script_path = formData.get('script_path');
            }
            jobData.execution_policy = formData.get('execution_policy');
            jobData.working_directory = formData.get('working_directory');
            
            // Parse parameters
            const params = formData.get('parameters');
            if (params) {
                jobData.parameters = params.split(' ').filter(p => p.trim());
            }
        }
        
        // Add schedule if enabled
        if (document.getElementById('enableSchedule').checked) {
            const scheduleType = document.querySelector('input[name="scheduleType"]:checked').value;
            const timezone = document.getElementById('scheduleTimezone').value;
            
            if (scheduleType === 'cron') {
                jobData.schedule = {
                    type: 'cron',
                    cron: document.getElementById('cronExpression').value,
                    timezone: timezone
                };
            } else if (scheduleType === 'interval') {
                jobData.schedule = {
                    type: 'interval',
                    interval: {
                        days: parseInt(document.getElementById('intervalDays').value),
                        hours: parseInt(document.getElementById('intervalHours').value),
                        minutes: parseInt(document.getElementById('intervalMinutes').value),
                        seconds: parseInt(document.getElementById('intervalSeconds').value)
                    },
                    timezone: timezone
                };
            } else if (scheduleType === 'once') {
                const date = document.getElementById('runDate').value;
                const time = document.getElementById('runTime').value;
                const localDateTime = `${date}T${time}:00`;
                
                // Convert to UTC if timezone is not UTC
                let utcDateTime = localDateTime;
                if (timezone !== 'UTC') {
                    try {
                        // Create date in specified timezone and convert to UTC
                        const tempDate = new Date(localDateTime);
                        const utcTime = new Date(tempDate.toLocaleString('en-US', { timeZone: 'UTC' }));
                        const localTime = new Date(tempDate.toLocaleString('en-US', { timeZone: timezone }));
                        const offset = localTime.getTime() - utcTime.getTime();
                        const utcDate = new Date(tempDate.getTime() - offset);
                        utcDateTime = utcDate.toISOString().slice(0, 19);
                    } catch (error) {
                        console.warn('Timezone conversion failed, using local time:', error);
                    }
                }
                
                jobData.schedule = {
                    type: 'date',
                    run_date: utcDateTime,
                    timezone: timezone,
                    local_time: localDateTime // Keep original for reference
                };
            }
        }
        
        // Submit to API
        fetch('/api/jobs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(jobData)
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showSuccess(data.message || 'Job created successfully!');
                setTimeout(() => {
                    window.location.href = `/jobs/${data.job_id}`;
                }, 2000);
            } else {
                showError(data.error || 'Failed to create job');
            }
        })
        .catch(error => {
            hideLoading();
            showError('Error creating job: ' + error.message);
        });
    });
    
    // Debug function for SQL jobs
    function debugFormData() {
        if (selectedJobType !== 'sql') {
            showError('This debug function is for SQL jobs only. Use "Debug PowerShell Data" for PowerShell jobs.');
            return;
        }
        
        if (!validateJob()) {
            showError('Please fix validation errors before debugging');
            return;
        }
        
        // Prepare SQL job data
        const formData = new FormData(document.getElementById('createJobForm'));
        const jobData = {
            type: selectedJobType,
            name: formData.get('name'),
            description: formData.get('description'),
            enabled: formData.get('enabled') === 'true',
            timeout: parseInt(formData.get('timeout')),
            max_retries: parseInt(formData.get('max_retries')),
            retry_delay: parseInt(formData.get('retry_delay')),
            run_as: formData.get('run_as')
        };
        
        const sqlQuery = formData.get('sql_query');
        const connectionName = formData.get('connection_name');
        
        jobData.sql_query = sqlQuery;
        jobData.connection_name = connectionName;
        
        console.log('=== SQL JOB DEBUG ===');
        console.log('SQL Query from form:', sqlQuery);
        console.log('SQL Query length:', sqlQuery ? sqlQuery.length : 0);
        console.log('Connection name:', connectionName);
        console.log('Full job data:', jobData);
        
        // Show debug info in alert
        const debugInfo = `SQL Job Debug Information:
- Job Name: ${jobData.name}
- Job Type: ${jobData.type}
- SQL Query: "${sqlQuery}"
- SQL Query Length: ${sqlQuery ? sqlQuery.length : 0} characters
- Connection: ${connectionName}
- Has SQL Query: ${!!sqlQuery}
- Full Data Keys: ${Object.keys(jobData).join(', ')}`;
        
        alert(debugInfo);
        showSuccess('SQL job debug data logged to console');
    }
    
    // Debug function for PowerShell jobs
    function debugPowerShellData() {
        if (selectedJobType !== 'powershell') {
            showError('This debug function is for PowerShell jobs only.');
            return;
        }
        
        if (!validateJob()) {
            showError('Please fix validation errors before debugging');
            return;
        }
        
        // Prepare PowerShell job data
        const formData = new FormData(document.getElementById('createJobForm'));
        const jobData = {
            type: selectedJobType,
            name: formData.get('name'),
            description: formData.get('description'),
            enabled: formData.get('enabled') === 'true',
            timeout: parseInt(formData.get('timeout')),
            max_retries: parseInt(formData.get('max_retries')),
            retry_delay: parseInt(formData.get('retry_delay')),
            run_as: formData.get('run_as')
        };
        
        const scriptType = document.querySelector('input[name="scriptType"]:checked').value;
        if (scriptType === 'inline') {
            jobData.script_content = formData.get('script_content');
        } else {
            jobData.script_path = formData.get('script_path');
        }
        jobData.execution_policy = formData.get('execution_policy');
        jobData.working_directory = formData.get('working_directory');
        
        const params = formData.get('parameters');
        if (params) {
            jobData.parameters = params.split(' ').filter(p => p.trim());
        }
        
        console.log('=== POWERSHELL JOB DEBUG ===');
        console.log('Script type:', scriptType);
        console.log('Script content:', jobData.script_content);
        console.log('Script path:', jobData.script_path);
        console.log('Execution policy:', jobData.execution_policy);
        console.log('Parameters:', jobData.parameters);
        console.log('Full job data:', jobData);
        
        // Show debug info in alert
        const debugInfo = `PowerShell Job Debug Information:
- Job Name: ${jobData.name}
- Job Type: ${jobData.type}
- Script Type: ${scriptType}
- Script Content Length: ${jobData.script_content ? jobData.script_content.length : 0} characters
- Script Path: ${jobData.script_path || 'None'}
- Execution Policy: ${jobData.execution_policy}
- Parameters: ${jobData.parameters ? jobData.parameters.length : 0} items
- Working Directory: ${jobData.working_directory || 'Default'}
- Full Data Keys: ${Object.keys(jobData).join(', ')}`;
        
        alert(debugInfo);
        showSuccess('PowerShell job debug data logged to console');
    }
    
    // Test PowerShell script syntax
    function testPowerShellScript() {
        if (selectedJobType !== 'powershell') {
            showError('Script testing is only available for PowerShell jobs');
            return;
        }
        
        const scriptType = document.querySelector('input[name="scriptType"]:checked').value;
        let scriptContent = '';
        
        if (scriptType === 'inline') {
            scriptContent = document.getElementById('scriptContent').value;
            if (!scriptContent || scriptContent.trim() === '') {
                showError('Please enter PowerShell script content to test');
                return;
            }
        } else {
            const scriptPath = document.getElementById('scriptPath').value;
            if (!scriptPath || scriptPath.trim() === '') {
                showError('Please enter PowerShell script path to test');
                return;
            }
            showInfo('Script syntax testing for file paths is not yet implemented. Use inline scripts for syntax testing.');
            return;
        }
        
        // Basic PowerShell syntax validation
        const commonErrors = [];
        
        // Check for unclosed strings
        const singleQuotes = (scriptContent.match(/'/g) || []).length;
        const doubleQuotes = (scriptContent.match(/"/g) || []).length;
        
        if (singleQuotes % 2 !== 0) {
            commonErrors.push('Unclosed single quote detected');
        }
        if (doubleQuotes % 2 !== 0) {
            commonErrors.push('Unclosed double quote detected');
        }
        
        // Check for basic PowerShell structure
        if (scriptContent.includes('function ') && !scriptContent.includes('{')) {
            commonErrors.push('Function definition without opening brace');
        }
        
        if (commonErrors.length > 0) {
            showError('Potential syntax issues found:\\n- ' + commonErrors.join('\\n- '));
        } else {
            showSuccess('Basic syntax validation passed! No obvious errors detected.');
        }
    }
    
    // Enhanced PowerShell script editor functions
    function expandScriptEditor() {
        const textarea = document.getElementById('scriptContent');
        const currentRows = parseInt(textarea.rows);
        
        if (currentRows <= 15) {
            textarea.rows = 35;
            textarea.style.minHeight = '600px';
        } else {
            textarea.rows = 15;
            textarea.style.minHeight = '300px';
        }
        updateScriptStats();
    }
    
    function formatScript() {
        const textarea = document.getElementById('scriptContent');
        let content = textarea.value;
        
        if (!content.trim()) {
            showError('No script content to format');
            return;
        }
        
        // Basic PowerShell formatting
        const lines = content.split('\n');
        const formatted = [];
        let indentLevel = 0;
        
        lines.forEach(line => {
            const trimmed = line.trim();
            
            // Decrease indent for closing braces
            if (trimmed === '}' || trimmed.startsWith('} ')) {
                indentLevel = Math.max(0, indentLevel - 1);
            }
            
            // Add the line with proper indentation
            if (trimmed) {
                formatted.push('    '.repeat(indentLevel) + trimmed);
            } else {
                formatted.push(''); // Preserve empty lines
            }
            
            // Increase indent for opening braces
            if (trimmed.endsWith('{') || trimmed.includes('if (') || trimmed.includes('while (') || 
                trimmed.includes('foreach (') || trimmed.includes('function ')) {
                indentLevel++;
            }
        });
        
        textarea.value = formatted.join('\n');
        updateScriptStats();
        showSuccess('Script formatted successfully');
    }
    
    function insertTemplate() {
        const template = `# PowerShell Script Template
# Generated on: ${new Date().toLocaleString()}

# Script configuration
$ErrorActionPreference = "Stop"
$ProgressPreference = "Continue"

# Script start
$startTime = Get-Date
Write-Host "====================================" -ForegroundColor Cyan
Write-Host "Script Execution Started" -ForegroundColor Green  
Write-Host "Start Time: $startTime" -ForegroundColor Yellow
Write-Host "====================================" -ForegroundColor Cyan

try {
    # Main script logic here
    Write-Host "Executing main script logic..." -ForegroundColor White
    
    # Example: System information
    Write-Host "Computer Name: $env:COMPUTERNAME" -ForegroundColor Gray
    Write-Host "User Name: $env:USERNAME" -ForegroundColor Gray
    Write-Host "PowerShell Version: $($PSVersionTable.PSVersion)" -ForegroundColor Gray
    
    # Your custom logic here
    
    Write-Host "Script logic completed successfully" -ForegroundColor Green
}
catch {
    Write-Error "Script failed with error: $($_.Exception.Message)"
    exit 1
}
finally {
    # Cleanup and final reporting
    $endTime = Get-Date
    $duration = $endTime - $startTime
    
    Write-Host "====================================" -ForegroundColor Cyan
    Write-Host "Script Execution Complete" -ForegroundColor Green
    Write-Host "End Time: $endTime" -ForegroundColor Yellow
    Write-Host "Duration: $($duration.ToString('hh\\:mm\\:ss'))" -ForegroundColor Yellow
    Write-Host "====================================" -ForegroundColor Cyan
}`;
        
        const textarea = document.getElementById('scriptContent');
        if (textarea.value.trim() && !confirm('This will replace the current script content. Are you sure?')) {
            return;
        }
        
        textarea.value = template;
        updateScriptStats();
        showSuccess('PowerShell template inserted successfully');
    }
    
    function updateScriptStats() {
        const textarea = document.getElementById('scriptContent');
        const content = textarea.value;
        
        const lineCount = content ? content.split('\n').length : 0;
        const charCount = content.length;
        
        document.getElementById('scriptLineCount').textContent = `Lines: ${lineCount}`;
        document.getElementById('scriptCharCount').textContent = `Characters: ${charCount}`;
    }
    
    // Add event listener for script content changes
    document.addEventListener('DOMContentLoaded', function() {
        const scriptContent = document.getElementById('scriptContent');
        if (scriptContent) {
            scriptContent.addEventListener('input', updateScriptStats);
            scriptContent.addEventListener('paste', function() {
                setTimeout(updateScriptStats, 10); // Allow paste to complete
            });
            updateScriptStats(); // Initial count
        }
    });
    
    // Load database connections
    function loadDatabaseConnections() {
        const connectionSelect = document.getElementById('connectionName');
        
        fetch('/api/connections')
            .then(response => response.json())
            .then(data => {
                connectionSelect.innerHTML = ''; // Clear loading option
                
                if (data.success && data.connections && data.connections.length > 0) {
                    // Add default empty option
                    const emptyOption = document.createElement('option');
                    emptyOption.value = '';
                    emptyOption.textContent = 'Select a connection...';
                    emptyOption.disabled = true;
                    emptyOption.selected = true;
                    connectionSelect.appendChild(emptyOption);
                    
                    // Add connections from database
                    data.connections.forEach(connection => {
                        const option = document.createElement('option');
                        option.value = connection.name;
                        option.textContent = `${connection.name} (${connection.server}/${connection.database})`;
                        option.dataset.server = connection.server;
                        option.dataset.database = connection.database;
                        option.dataset.authType = connection.auth_type;
                        connectionSelect.appendChild(option);
                    });
                } else {
                    // No connections found
                    const noOption = document.createElement('option');
                    noOption.value = '';
                    noOption.textContent = 'No connections available - create one first';
                    noOption.disabled = true;
                    noOption.selected = true;
                    connectionSelect.appendChild(noOption);
                }
            })
            .catch(error => {
                console.error('Error loading connections:', error);
                connectionSelect.innerHTML = '';
                const errorOption = document.createElement('option');
                errorOption.value = '';
                errorOption.textContent = 'Error loading connections';
                errorOption.disabled = true;
                errorOption.selected = true;
                connectionSelect.appendChild(errorOption);
            });
    }
    
    // Timezone handling functions
    function updateTimezoneInfo() {
        const timezone = document.getElementById('scheduleTimezone').value;
        const infoDiv = document.getElementById('timezoneInfo');
        
        try {
            const now = new Date();
            const utcTime = now.toUTCString();
            const localTime = now.toLocaleString('en-US', { 
                timeZone: timezone,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
            
            // Calculate offset
            const localDate = new Date(now.toLocaleString('en-US', { timeZone: timezone }));
            const utcDate = new Date(now.toLocaleString('en-US', { timeZone: 'UTC' }));
            const offsetMs = localDate.getTime() - utcDate.getTime();
            const offsetHours = offsetMs / (1000 * 60 * 60);
            const offsetSign = offsetHours >= 0 ? '+' : '';
            
            infoDiv.innerHTML = `
                <small>
                    <strong>Current Time:</strong> ${localTime} (UTC${offsetSign}${offsetHours})
                    <br><strong>UTC Time:</strong> ${utcTime}
                </small>
            `;
        } catch (error) {
            infoDiv.innerHTML = `<small class="text-warning">Timezone information not available</small>`;
        }
    }
    
    // Convert local time to UTC for storage
    function convertToUTC(localDateTime, timezone) {
        if (timezone === 'UTC') {
            return localDateTime;
        }
        
        try {
            // Create a date object in the specified timezone
            const localDate = new Date(localDateTime + ' ' + timezone);
            return localDate.toISOString();
        } catch (error) {
            console.warn('Timezone conversion failed, using local time:', error);
            return localDateTime;
        }
    }
    
    // Auto-detect user's timezone
    function detectUserTimezone() {
        try {
            const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const timezoneSelect = document.getElementById('scheduleTimezone');
            
            // Check if user's timezone is in our list
            const option = Array.from(timezoneSelect.options).find(opt => opt.value === userTimezone);
            if (option) {
                timezoneSelect.value = userTimezone;
                updateTimezoneInfo();
                console.log('Auto-detected timezone:', userTimezone);
            } else {
                console.log('User timezone not in list:', userTimezone);
            }
        } catch (error) {
            console.warn('Could not detect user timezone:', error);
        }
    }

    // Initialize form
    document.addEventListener('DOMContentLoaded', function() {
        // Set default date/time
        setDefaultDateTime();
        
        // Load database connections when SQL job type is selected
        loadDatabaseConnections();
        
        // Auto-detect and set user's timezone
        detectUserTimezone();
        
        // Add timezone change handler
        document.getElementById('scheduleTimezone').addEventListener('change', updateTimezoneInfo);
        
        // Update timezone info initially
        updateTimezoneInfo();
        
        // Initialize custom auth type handler
        const customAuthType = document.getElementById('customAuthType');
        const sqlAuthFields = document.getElementById('sqlAuthFields');
        
        // Handle auth type changes
        if (customAuthType && sqlAuthFields) {
            customAuthType.addEventListener('change', function() {
                if (this.value === 'sql') {
                    sqlAuthFields.style.display = 'block';
                    document.getElementById('customUsername').required = true;
                    document.getElementById('customPassword').required = true;
                } else {
                    sqlAuthFields.style.display = 'none';
                    document.getElementById('customUsername').required = false;
                    document.getElementById('customPassword').required = false;
                }
            });
            
            // Initialize SQL auth fields as visible (since SQL is now default)
            if (customAuthType.value === 'sql') {
                sqlAuthFields.style.display = 'block';
                document.getElementById('customUsername').required = true;
                document.getElementById('customPassword').required = true;
            }
        }
        
        // Load agent pools when page loads
        loadAgentPools();
    });
    
    // ================== AGENT JOB FUNCTIONS ==================
    
    // Load available agent pools
    function loadAgentPools() {
        fetch('/api/agent/pools')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('agentPool');
                select.innerHTML = '<option value="" disabled selected>Select an agent pool...</option>';
                
                if (data.success && data.pools && data.pools.length > 0) {
                    data.pools.forEach(pool => {
                        const option = document.createElement('option');
                        option.value = pool.pool_name;
                        option.textContent = `${pool.pool_name} (${pool.agent_count} agents)`;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="default">default (No pools configured)</option>';
                }
            })
            .catch(error => {
                console.error('Error loading agent pools:', error);
                const select = document.getElementById('agentPool');
                select.innerHTML = '<option value="default">default (Error loading pools)</option>';
            });
    }
    
    // Toggle execution strategy options
    function toggleExecutionOptions() {
        const strategy = document.getElementById('executionStrategy').value;
        const multiConfigSection = document.getElementById('multiConfigSection');
        const multiAgentSection = document.getElementById('multiAgentSection');
        
        // Hide all sections first
        if (multiConfigSection) multiConfigSection.style.display = 'none';
        if (multiAgentSection) multiAgentSection.style.display = 'none';
        
        // Show relevant section
        if (strategy === 'multi_configuration' && multiConfigSection) {
            multiConfigSection.style.display = 'block';
        } else if (strategy === 'multi_agent' && multiAgentSection) {
            multiAgentSection.style.display = 'block';
        }
    }
    
    // Create agent job (with integrated validation)
    function createAgentJob() {
        // Integrated validation before creating job
        const form = document.getElementById('createJobForm');
        const formData = new FormData(form);
        
        // Basic validation
        if (!formData.get('name')) {
            showError('Job name is required');
            return;
        }
        
        if (!formData.get('agent_pool')) {
            showError('Agent pool selection is required');
            return;
        }
        
        const jobSteps = document.getElementById('agentJobSteps').value.trim(); // Fixed: correct ID
        if (!jobSteps) {
            showError('Job steps YAML is required');
            return;
        }
        
        // Validate YAML syntax
        try {
            // Basic YAML validation (check for common issues)
            if (!jobSteps.includes('steps:') && !jobSteps.includes('- name:')) {
                throw new Error('Job steps should contain "steps:" section with step definitions');
            }
        } catch (error) {
            showError('Invalid YAML syntax in job steps: ' + error.message);
            return;
        }
        
        // Strategy-specific validation
        const strategy = formData.get('execution_strategy');
        if (strategy === 'multi_configuration') {
            const configs = formData.get('configurations');
            if (configs) {
                try {
                    const configArray = JSON.parse(configs);
                    if (!Array.isArray(configArray) || configArray.length === 0) {
                        throw new Error('Configurations must be a non-empty array');
                    }
                } catch (error) {
                    showError('Invalid configurations JSON: ' + error.message);
                    return;
                }
            }
        } else if (strategy === 'multi_agent') {
            const agentCount = parseInt(formData.get('agent_count'));
            if (isNaN(agentCount) || agentCount < 2 || agentCount > 20) {
                showError('Agent count must be between 2 and 20 for multi-agent execution');
                return;
            }
        }
        
        // Show validation success message
        showSuccess('Agent job configuration validated successfully!');
        
        // Validation passed - proceed with job creation
        setTimeout(() => {
            // Use the existing formData from validation
            const jobData = {
                type: 'agent_job',
            name: formData.get('name'),
            description: formData.get('description'),
            enabled: formData.get('enabled') === 'true',
            timeout: parseInt(formData.get('timeout')) || 300,
            max_retries: parseInt(formData.get('max_retries')) || 3,
            retry_delay: parseInt(formData.get('retry_delay')) || 60,
            // Agent-specific fields (flattened to match backend expectations)
            agent_pool: formData.get('agent_pool'),
            execution_strategy: formData.get('execution_strategy') || 'default_pool', 
            job_steps: document.getElementById('agentJobSteps').value,  // Fixed: correct ID
            agent_capabilities: formData.get('agent_capabilities') ? 
                formData.get('agent_capabilities').split(',').map(s => s.trim()) : []
        };
        
        // Handle scheduling
        const enableSchedule = document.getElementById('enableSchedule').checked;
        if (enableSchedule) {
            const scheduleType = document.querySelector('input[name="scheduleType"]:checked').value;
            const timezone = document.getElementById('scheduleTimezone').value;
            
            if (scheduleType === 'cron') {
                jobData.schedule = {
                    type: 'cron',
                    cron: formData.get('cron_expression'),
                    timezone: timezone
                };
            } else if (scheduleType === 'interval') {
                const intervalValue = parseInt(formData.get('interval_value'));
                const intervalUnit = formData.get('interval_unit');
                jobData.schedule = {
                    type: 'interval',
                    [intervalUnit]: intervalValue,
                    timezone: timezone
                };
            } else if (scheduleType === 'once') {
                const runDate = formData.get('run_date');
                const runTime = formData.get('run_time');
                const localDateTime = `${runDate}T${runTime}:00`;
                
                let utcDateTime = localDateTime;
                if (timezone !== 'UTC') {
                    try {
                        const tempDate = new Date(localDateTime);
                        const utcTime = new Date(tempDate.toLocaleString('en-US', { timeZone: 'UTC' }));
                        const localTime = new Date(tempDate.toLocaleString('en-US', { timeZone: timezone }));
                        const offset = localTime.getTime() - utcTime.getTime();
                        const utcDate = new Date(tempDate.getTime() - offset);
                        utcDateTime = utcDate.toISOString().slice(0, 19);
                    } catch (error) {
                        console.warn('Timezone conversion failed, using local time:', error);
                    }
                }
                
                jobData.schedule = {
                    type: 'date',
                    run_date: utcDateTime,
                    timezone: timezone,
                    local_time: localDateTime
                };
            }
        }
        
        // Simple confirmation for YAML-focused approach
        const yamlContent = document.getElementById('agentJobSteps').value.trim();
        const jobName = jobData.name || 'Unnamed Job';
        const agentPool = jobData.agent_pool || 'default';
        
        const confirmed = confirm(`Create Agent Job?\n\nJob Name: ${jobName}\nAgent Pool: ${agentPool}\nExecution Strategy: ${jobData.execution_strategy}\n\nThis will create an agent job with the YAML configuration you provided.\n\nProceed?`);
        
        if (confirmed) {
            submitAgentJob(jobData);
        }
        }, 1000); // End setTimeout - brief delay to show validation success
    }
    
    // Submit agent job to API
    function submitAgentJob(jobData) {
        showLoading('Creating agent job...');
        
        fetch('/api/jobs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(jobData)
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showSuccess(data.message || 'Agent job created successfully!');
                setTimeout(() => {
                    window.location.href = `/jobs/${data.job_id}`;
                }, 2000);
            } else {
                showError(data.error || 'Failed to create agent job');
            }
        })
        .catch(error => {
            hideLoading();
            showError('Error creating agent job: ' + error.message);
        });
    }
    
    
    
    // Update selectJobType function to handle agent jobs
    const originalSelectJobType = selectJobType;
    selectJobType = function(type) {
        originalSelectJobType(type);
        
        // Handle agent job specific UI
        if (type === 'agent') {
            document.getElementById('agentJobActions').style.display = 'block';
            document.getElementById('sqlJobActions').style.display = 'none';
            document.getElementById('powershellJobActions').style.display = 'none';
            document.getElementById('defaultJobActions').style.display = 'none';
            
            // Load agent pools when agent job type is selected
            loadAgentPools();
        }
    };
</script>
{% endblock %}