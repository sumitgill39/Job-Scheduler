{% extends "base.html" %}

{% block title %}Execution History - Windows Job Scheduler{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">
                        <i class="fas fa-history me-2"></i>Job Execution History & UTC Precision
                    </h4>
                    <small class="text-muted">Complete execution history with UTC timing and scheduling precision analysis</small>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshHistory()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="exportHistory()">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                </div>
            </div>
            
            <div class="card-body">
                <!-- Filters and Search -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <label class="form-label">Status Filter</label>
                        <select class="form-select" id="statusFilter" onchange="applyFilters()">
                            <option value="">All Statuses</option>
                            <option value="success">Success</option>
                            <option value="failed">Failed</option>
                            <option value="running">Running</option>
                            <option value="timeout">Timeout</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="retry">Retry</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Job Type</label>
                        <select class="form-select" id="jobTypeFilter" onchange="applyFilters()">
                            <option value="">All Types</option>
                            <option value="sql">SQL Jobs</option>
                            <option value="powershell">PowerShell Jobs</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Date Range</label>
                        <select class="form-select" id="dateRangeFilter" onchange="applyFilters()">
                            <option value="today">Today</option>
                            <option value="week">Last 7 Days</option>
                            <option value="month">Last 30 Days</option>
                            <option value="all" selected>All Time</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Search</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search job name..." 
                               oninput="applyFilters()">
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="row mb-4">
                    <div class="col-lg-2 col-md-4 col-sm-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <div class="metric-number text-primary" id="totalExecutions">-</div>
                                <div class="metric-label">Total Executions</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-sm-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <div class="metric-number text-success" id="successfulExecutions">-</div>
                                <div class="metric-label">Successful</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-sm-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <div class="metric-number text-danger" id="failedExecutions">-</div>
                                <div class="metric-label">Failed</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-sm-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <div class="metric-number text-info" id="avgDuration">-</div>
                                <div class="metric-label">Avg Duration</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-sm-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <div class="metric-number text-success" id="utcPrecision">-</div>
                                <div class="metric-label">UTC Precision</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-sm-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <div class="metric-number text-warning" id="avgDelay">-</div>
                                <div class="metric-label">Avg Delay</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Table -->
                <div class="table-responsive">
                    <table class="table table-hover" id="historyTable">
                        <thead class="table-dark">
                            <tr>
                                <th onclick="sortTable('start_time')" style="cursor: pointer;">
                                    <i class="fas fa-clock me-1"></i>UTC Execution Time
                                    <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th onclick="sortTable('job_name')" style="cursor: pointer;">
                                    <i class="fas fa-briefcase me-1"></i>Job Name
                                    <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th onclick="sortTable('job_type')" style="cursor: pointer;">
                                    <i class="fas fa-cog me-1"></i>Type
                                    <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th onclick="sortTable('status')" style="cursor: pointer;">
                                    <i class="fas fa-flag me-1"></i>Status
                                    <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th onclick="sortTable('duration_seconds')" style="cursor: pointer;">
                                    <i class="fas fa-stopwatch me-1"></i>Duration
                                </th>
                                <th onclick="sortTable('precision')" style="cursor: pointer;">
                                    <i class="fas fa-target me-1"></i>UTC Precision
                                    <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th>
                                    <i class="fas fa-info-circle me-1"></i>Details
                                </th>
                                <th>
                                    <i class="fas fa-tools me-1"></i>Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-4">
                    <div>
                        <span id="recordsInfo">Showing 0 - 0 of 0 records</span>
                    </div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0" id="pagination">
                            <!-- Will be populated by JavaScript -->
                        </ul>
                    </nav>
                </div>

                <!-- Loading State -->
                <div id="historyLoading" class="text-center py-5" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Loading execution history...</div>
                </div>

                <!-- No Data State -->
                <div id="noHistoryData" class="text-center py-5" style="display: none;">
                    <i class="fas fa-history fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Execution History Found</h5>
                    <p class="text-muted">No job executions match your current filters.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Execution Details Modal -->
<div class="modal fade" id="executionDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>Execution Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="executionDetailsBody">
                <!-- Will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" onclick="exportExecutionDetails()">
                    <i class="fas fa-download me-1"></i>Export Details
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .metric-card {
        text-align: center;
        padding: 1.5rem;
    }
    
    .metric-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .metric-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .table th {
        white-space: nowrap;
        user-select: none;
    }
    
    .table th:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .status-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 20px;
        font-weight: 600;
    }
    
    .duration-badge {
        font-family: 'Courier New', monospace;
        font-size: 0.8rem;
    }
    
    .job-type-icon {
        width: 20px;
        text-align: center;
    }
    
    .execution-row:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    .filters-section {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .pagination-sm .page-link {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .table-responsive {
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .card {
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-radius: 10px;
    }
    
    .status-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-failed {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .status-running {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    
    .status-pending {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .status-cancelled {
        background-color: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
    }
    
    .status-timeout {
        background-color: #ffeaa7;
        color: #856404;
        border: 1px solid #fdd835;
    }
    
    .status-retry {
        background-color: #e2e3e5;
        color: #41464b;
        border: 1px solid #d6d8db;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    let pageSize = 50;
    let sortField = 'start_time';
    let sortDirection = 'desc';
    let allExecutions = [];
    let filteredExecutions = [];

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadExecutionHistory();
        
        // Auto-refresh every 30 seconds
        setInterval(loadExecutionHistory, 30000);
    });

    // Load execution history from API
    function loadExecutionHistory() {
        showLoading(true);
        
        fetch('/api/executions/history')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allExecutions = data.executions || [];
                    applyFilters();
                    updateSummaryCards();
                } else {
                    showError('Failed to load execution history: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error loading execution history:', error);
                showError('Error loading execution history: ' + error.message);
            })
            .finally(() => {
                showLoading(false);
            });
    }

    // Apply filters and search
    function applyFilters() {
        const statusFilter = document.getElementById('statusFilter').value;
        const jobTypeFilter = document.getElementById('jobTypeFilter').value;
        const dateRangeFilter = document.getElementById('dateRangeFilter').value;
        const searchQuery = document.getElementById('searchInput').value.toLowerCase();

        filteredExecutions = allExecutions.filter(execution => {
            // Status filter
            if (statusFilter && execution.status !== statusFilter) return false;
            
            // Job type filter (extract from metadata or job_name)
            if (jobTypeFilter) {
                const jobType = execution.metadata?.job_type || 
                               (execution.job_name.toLowerCase().includes('sql') ? 'sql' : 'powershell');
                if (jobType !== jobTypeFilter) return false;
            }
            
            // Date range filter
            if (dateRangeFilter !== 'all') {
                const executionDate = new Date(execution.start_time);
                const now = new Date();
                const daysDiff = (now - executionDate) / (1000 * 60 * 60 * 24);
                
                if (dateRangeFilter === 'today' && daysDiff > 1) return false;
                if (dateRangeFilter === 'week' && daysDiff > 7) return false;
                if (dateRangeFilter === 'month' && daysDiff > 30) return false;
            }
            
            // Search filter
            if (searchQuery && !execution.job_name.toLowerCase().includes(searchQuery)) return false;
            
            return true;
        });

        // Sort filtered results
        sortExecutions();
        
        // Reset to first page
        currentPage = 1;
        
        // Render table
        renderHistoryTable();
        renderPagination();
    }

    // Sort executions
    function sortExecutions() {
        filteredExecutions.sort((a, b) => {
            let aVal = a[sortField];
            let bVal = b[sortField];
            
            // Handle different data types
            if (sortField === 'start_time' || sortField === 'end_time') {
                aVal = new Date(aVal);
                bVal = new Date(bVal);
            } else if (sortField === 'duration_seconds') {
                aVal = parseFloat(aVal) || 0;
                bVal = parseFloat(bVal) || 0;
            } else if (typeof aVal === 'string') {
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
            }
            
            if (sortDirection === 'asc') {
                return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
            } else {
                return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
            }
        });
    }

    // Sort table by field
    function sortTable(field) {
        if (sortField === field) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortField = field;
            sortDirection = 'desc';
        }
        
        applyFilters();
    }

    // Render history table
    function renderHistoryTable() {
        const tbody = document.getElementById('historyTableBody');
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, filteredExecutions.length);
        const pageExecutions = filteredExecutions.slice(startIndex, endIndex);

        if (pageExecutions.length === 0) {
            tbody.innerHTML = '';
            document.getElementById('noHistoryData').style.display = 'block';
            document.getElementById('recordsInfo').textContent = 'Showing 0 - 0 of 0 records';
            return;
        }

        document.getElementById('noHistoryData').style.display = 'none';

        tbody.innerHTML = pageExecutions.map(execution => {
            const startTime = new Date(execution.start_time);
            const duration = execution.duration_seconds ? 
                formatDuration(execution.duration_seconds) : 'N/A';
            const status = execution.status || 'unknown';
            const jobType = execution.metadata?.job_type || 'unknown';

            return `
                <tr class="execution-row">
                    <td>
                        <div>${startTime.toLocaleString()} <span class="badge bg-info">UTC</span></div>
                        <small class="text-muted">${getRelativeTime(startTime)}</small>
                    </td>
                    <td>
                        <div class="fw-bold">${execution.job_name}</div>
                        <small class="text-muted">ID: ${execution.job_id}</small>
                    </td>
                    <td>
                        <span class="badge bg-light text-dark">
                            <i class="${getJobTypeIcon(jobType)} job-type-icon me-1"></i>
                            ${jobType.toUpperCase()}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${getStatusClass(status)}">${status.toUpperCase()}</span>
                    </td>
                    <td>
                        <span class="duration-badge">${duration}</span>
                    </td>
                    <td>
                        ${getUTCPrecisionBadge(execution)}
                    </td>
                    <td>
                        <button class="btn btn-outline-info btn-sm" onclick="showExecutionDetails(${execution.execution_id})"
                            <i class="fas fa-eye me-1"></i>View
                        </button>
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-primary btn-sm" onclick="viewJobDetails('${execution.job_id}')" title="View Job">
                                <i class="fas fa-briefcase"></i>
                            </button>
                            ${execution.status === 'failed' ? `
                            <button class="btn btn-outline-warning btn-sm" onclick="retryJob('${execution.job_id}')" title="Retry Job">
                                <i class="fas fa-redo"></i>
                            </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `;
        }).join('');

        // Update records info
        document.getElementById('recordsInfo').textContent = 
            `Showing ${startIndex + 1} - ${endIndex} of ${filteredExecutions.length} records`;
    }

    // Render pagination
    function renderPagination() {
        const pagination = document.getElementById('pagination');
        const totalPages = Math.ceil(filteredExecutions.length / pageSize);

        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }

        let paginationHTML = '';

        // Previous button
        paginationHTML += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
            </li>
        `;

        // Page numbers
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>
            `;
        }

        // Next button
        paginationHTML += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
            </li>
        `;

        pagination.innerHTML = paginationHTML;
    }

    // Change page
    function changePage(page) {
        const totalPages = Math.ceil(filteredExecutions.length / pageSize);
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            renderHistoryTable();
            renderPagination();
        }
    }

    // Update summary cards
    function updateSummaryCards() {
        const total = allExecutions.length;
        const successful = allExecutions.filter(e => e.status === 'success').length;
        const failed = allExecutions.filter(e => e.status === 'failed').length;
        
        const durations = allExecutions
            .filter(e => e.duration_seconds)
            .map(e => parseFloat(e.duration_seconds));
        const avgDuration = durations.length > 0 ? 
            durations.reduce((sum, d) => sum + d, 0) / durations.length : 0;

        // Calculate UTC precision statistics
        const precisionData = allExecutions.map(e => {
            const metadata = JSON.parse(e.metadata || '{}');
            if (metadata.utc_timing && metadata.utc_timing.delay_milliseconds !== undefined) {
                return Math.abs(metadata.utc_timing.delay_milliseconds);
            }
            // Fallback estimation
            if (e.start_time) {
                const startTime = new Date(e.start_time);
                return startTime.getMilliseconds() + (startTime.getSeconds() * 1000);
            }
            return null;
        }).filter(delay => delay !== null);

        const precisionsWithin5s = precisionData.filter(delay => delay <= 5000).length;
        const utcPrecisionPercentage = precisionData.length > 0 ? 
            (precisionsWithin5s / precisionData.length) * 100 : 0;
        
        const avgDelay = precisionData.length > 0 ? 
            precisionData.reduce((sum, d) => sum + d, 0) / precisionData.length : 0;

        document.getElementById('totalExecutions').textContent = total.toLocaleString();
        document.getElementById('successfulExecutions').textContent = successful.toLocaleString();
        document.getElementById('failedExecutions').textContent = failed.toLocaleString();
        document.getElementById('avgDuration').textContent = formatDuration(avgDuration);
        document.getElementById('utcPrecision').textContent = `${utcPrecisionPercentage.toFixed(1)}%`;
        document.getElementById('avgDelay').textContent = avgDelay >= 1000 ? 
            `${(avgDelay/1000).toFixed(1)}s` : `${Math.round(avgDelay)}ms`;
    }

    // Show execution details modal
    function showExecutionDetails(executionId) {
        const execution = allExecutions.find(e => e.execution_id === executionId);
        if (!execution) return;

        const modalBody = document.getElementById('executionDetailsBody');
        const startTime = new Date(execution.start_time);
        const endTime = execution.end_time ? new Date(execution.end_time) : null;
        
        // Parse metadata to extract result data and other information
        let metadata = {};
        let resultData = null;
        let connectionInfo = null;
        
        try {
            metadata = JSON.parse(execution.metadata || '{}');
            resultData = metadata.result_data;
            connectionInfo = {
                connection_name: metadata.connection_name,
                query: metadata.query
            };
        } catch (e) {
            console.warn('Failed to parse metadata:', e);
        }

        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-info-circle me-2"></i>Execution Information</h6>
                    <table class="table table-sm table-bordered">
                        <tr><td><strong>Execution ID:</strong></td><td>${execution.execution_id}</td></tr>
                        <tr><td><strong>Job Name:</strong></td><td>${execution.job_name}</td></tr>
                        <tr><td><strong>Job ID:</strong></td><td>${execution.job_id}</td></tr>
                        <tr><td><strong>Status:</strong></td><td><span class="status-badge ${getStatusClass(execution.status)}">${execution.status.toUpperCase()}</span></td></tr>
                        <tr><td><strong>Start Time:</strong></td><td>${startTime.toLocaleString()}</td></tr>
                        <tr><td><strong>End Time:</strong></td><td>${endTime ? endTime.toLocaleString() : 'N/A'}</td></tr>
                        <tr><td><strong>Duration:</strong></td><td>${execution.duration_seconds ? formatDuration(execution.duration_seconds) : 'N/A'}</td></tr>
                        <tr><td><strong>Return Code:</strong></td><td>${execution.return_code || 'N/A'}</td></tr>
                        <tr><td><strong>Retry Count:</strong></td><td>${execution.retry_count || 0} / ${execution.max_retries || 0}</td></tr>
                        ${connectionInfo && connectionInfo.connection_name ? `
                            <tr><td><strong>Connection:</strong></td><td>${maskSensitiveData(connectionInfo.connection_name)}</td></tr>
                        ` : ''}
                    </table>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-terminal me-2"></i>Output Summary</h6>
                    <div class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;">
                        <pre style="margin: 0; white-space: pre-wrap;">${maskSensitiveData(execution.output || 'No output available')}</pre>
                    </div>
                    ${execution.error_message ? `
                        <h6 class="mt-3"><i class="fas fa-exclamation-triangle me-2 text-danger"></i>Error Message</h6>
                        <div class="bg-danger bg-opacity-10 p-3 rounded">
                            <pre style="margin: 0; white-space: pre-wrap;">${maskSensitiveData(execution.error_message)}</pre>
                        </div>
                    ` : ''}
                </div>
            </div>
            
            ${resultData ? renderQueryResults(resultData) : ''}
            
            ${connectionInfo && connectionInfo.query ? `
                <div class="mt-3">
                    <h6><i class="fas fa-code me-2"></i>SQL Query</h6>
                    <div class="bg-light p-3 rounded">
                        <pre style="margin: 0; font-family: 'Courier New', monospace; font-size: 0.9rem;">${maskSensitiveData(connectionInfo.query)}</pre>
                    </div>
                </div>
            ` : ''}
            
            ${execution.metadata ? `
                <div class="mt-3">
                    <h6><i class="fas fa-database me-2"></i>Technical Metadata</h6>
                    <div class="bg-light p-3 rounded">
                        <pre style="margin: 0; font-size: 0.85rem;">${JSON.stringify(sanitizeMetadata(metadata), null, 2)}</pre>
                    </div>
                </div>
            ` : ''}
        `;

        new bootstrap.Modal(document.getElementById('executionDetailsModal')).show();
    }
    
    // Render SQL query results in tabular format
    function renderQueryResults(resultData) {
        if (!resultData) return '';
        
        // Handle different result types
        if (resultData.query_type === 'non_select') {
            const operationType = getOperationType(resultData);
            const icon = getOperationIcon(operationType);
            const colorClass = getOperationColorClass(operationType);
            
            return `
                <div class="mt-3">
                    <h6><i class="${icon} me-2 ${colorClass}"></i>Database Operation Result</h6>
                    <div class="alert alert-${getAlertClass(operationType)} d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Operation Type:</strong> ${operationType}<br>
                                    <strong>Rows Affected:</strong> ${resultData.rows_affected || 0}
                                </div>
                                <div class="col-md-6">
                                    ${resultData.execution_time ? `<strong>Execution Time:</strong> ${resultData.execution_time}ms<br>` : ''}
                                    <strong>Status:</strong> <span class="badge bg-success">Completed</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="display-6 ${colorClass}">${resultData.rows_affected || 0}</div>
                            <small class="text-muted">rows</small>
                        </div>
                    </div>
                    ${resultData.additional_info ? `
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                ${resultData.additional_info}
                            </small>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Handle SELECT query results
        if (resultData.columns && resultData.rows) {
            const maxDisplayRows = 100; // Increased limit for better visibility
            const displayRows = resultData.rows.slice(0, maxDisplayRows);
            const hasMoreRows = resultData.rows.length > maxDisplayRows;
            
            return `
                <div class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">
                            <i class="fas fa-table me-2 text-primary"></i>Query Results 
                            <span class="badge bg-secondary">${resultData.row_count || 0} rows</span>
                            ${resultData.truncated ? '<span class="badge bg-warning ms-1">Truncated</span>' : ''}
                        </h6>
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-primary btn-sm" onclick="exportQueryResults(${JSON.stringify(resultData).replace(/"/g, '&quot;')})" title="Export to CSV">
                                <i class="fas fa-download me-1"></i>Export CSV
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="toggleResultsView(this)" title="Toggle view mode">
                                <i class="fas fa-list me-1"></i>Raw View
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tabular View -->
                    <div class="results-table-view">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem;">
                            <table class="table table-sm table-striped table-hover mb-0">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th style="font-size: 0.8rem; width: 40px; text-align: center;">#</th>
                                        ${resultData.columns.map(col => `<th style="font-size: 0.85rem; min-width: 120px;">${maskSensitiveData(col)}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${displayRows.map((row, index) => `
                                        <tr>
                                            <td style="font-size: 0.75rem; color: #6c757d; text-align: center;">${index + 1}</td>
                                            ${row.map(cell => {
                                                const cellValue = cell === null ? '<span class="text-muted fst-italic">NULL</span>' : 
                                                                cell === undefined ? '<span class="text-muted fst-italic">undefined</span>' :
                                                                cell === '' ? '<span class="text-muted fst-italic">empty</span>' :
                                                                maskSensitiveData(String(cell));
                                                return `<td style="font-size: 0.8rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${maskSensitiveData(String(cell || ''))}">${cellValue}</td>`;
                                            }).join('')}
                                        </tr>
                                    `).join('')}
                                    ${hasMoreRows ? `
                                        <tr class="table-warning">
                                            <td colspan="${resultData.columns.length + 1}" class="text-center fst-italic">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Showing first ${maxDisplayRows} rows. ${resultData.rows.length - maxDisplayRows} more rows available.
                                                <button class="btn btn-link btn-sm p-0 ms-2" onclick="showAllResults(${JSON.stringify(resultData).replace(/"/g, '&quot;')})">Show All</button>
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Raw JSON View (hidden by default) -->
                    <div class="results-raw-view" style="display: none;">
                        <div class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">
                            <pre style="margin: 0; font-size: 0.8rem;">${JSON.stringify(resultData, null, 2)}</pre>
                        </div>
                    </div>
                    
                    <!-- Summary Information -->
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            ${resultData.columns.length} columns × ${resultData.row_count || resultData.rows.length} rows
                            ${resultData.execution_time ? ` • Executed in ${resultData.execution_time}ms` : ''}
                        </small>
                    </div>
                </div>
            `;
        }
        
        return '';
    }
    
    // Mask sensitive data based on environment
    function maskSensitiveData(data) {
        if (!data || typeof data !== 'string') return data || '';
        
        // Simple masking rules - can be enhanced based on environment configuration
        const sensitivePatterns = [
            // SQL connection strings
            /(server|data source)\s*=\s*[^;]+/gi,
            // Passwords
            /(password|pwd)\s*=\s*[^;\s]+/gi,
            // IP addresses (basic pattern)
            /\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b/g,
            // Email addresses
            /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g
        ];
        
        let maskedData = data;
        
        // Apply masking patterns
        sensitivePatterns.forEach(pattern => {
            maskedData = maskedData.replace(pattern, (match) => {
                if (match.includes('=')) {
                    const [key, value] = match.split('=');
                    return `${key}=***MASKED***`;
                }
                return '***MASKED***';
            });
        });
        
        return maskedData;
    }
    
    // Sanitize metadata for display
    function sanitizeMetadata(metadata) {
        const sanitized = { ...metadata };
        
        // Remove or mask sensitive fields
        if (sanitized.query) {
            sanitized.query = maskSensitiveData(sanitized.query);
        }
        
        if (sanitized.connection_name) {
            sanitized.connection_name = maskSensitiveData(sanitized.connection_name);
        }
        
        // Remove large result data from metadata display (already shown in results section)
        if (sanitized.result_data && sanitized.result_data.rows) {
            sanitized.result_data = {
                ...sanitized.result_data,
                rows: `[${sanitized.result_data.rows.length} rows - displayed above]`
            };
        }
        
        return sanitized;
    }

    // Utility functions
    function formatDuration(seconds) {
        if (!seconds || seconds < 0) return 'N/A';
        
        const hrs = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        
        if (hrs > 0) return `${hrs}h ${mins}m ${secs}s`;
        if (mins > 0) return `${mins}m ${secs}s`;
        return `${secs}s`;
    }

    function getRelativeTime(date) {
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        
        if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
        if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
        if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
        return 'Just now';
    }

    function getStatusClass(status) {
        const statusClasses = {
            'success': 'status-success',
            'failed': 'status-failed',
            'running': 'status-running',
            'pending': 'status-pending',
            'cancelled': 'status-cancelled',
            'timeout': 'status-timeout',
            'retry': 'status-retry'
        };
        return statusClasses[status] || 'status-pending';
    }

    function getJobTypeIcon(type) {
        return type === 'sql' ? 'fas fa-database' : 'fab fa-microsoft';
    }

    function getUTCPrecisionBadge(execution) {
        // Extract UTC timing information from metadata or calculate from execution data
        const metadata = execution.metadata || {};
        
        // Check if we have detailed UTC timing information
        if (metadata.utc_timing) {
            const delay = metadata.utc_timing.delay_milliseconds || 0;
            const delayAbs = Math.abs(delay);
            
            if (delayAbs <= 1000) { // Within 1 second
                return `<span class="badge bg-success" title="Excellent precision">
                    <i class="fas fa-bullseye me-1"></i>${delayAbs}ms
                </span>`;
            } else if (delayAbs <= 5000) { // Within 5 seconds
                return `<span class="badge bg-warning" title="Good precision">
                    <i class="fas fa-target me-1"></i>${delayAbs}ms
                </span>`;
            } else {
                return `<span class="badge bg-danger" title="Poor precision">
                    <i class="fas fa-exclamation-triangle me-1"></i>${delayAbs}ms
                </span>`;
            }
        }
        
        // Fallback: Estimate precision based on execution timing patterns
        if (execution.start_time) {
            const startTime = new Date(execution.start_time);
            const seconds = startTime.getSeconds();
            const milliseconds = startTime.getMilliseconds();
            
            // If execution started very close to a round minute/second, likely good precision
            if (seconds === 0 && milliseconds < 100) {
                return `<span class="badge bg-success" title="Estimated excellent precision">
                    <i class="fas fa-check me-1"></i>~${milliseconds}ms
                </span>`;
            } else if (seconds < 5 || seconds > 55) {
                return `<span class="badge bg-info" title="Estimated good precision">
                    <i class="fas fa-clock me-1"></i>~${seconds}s
                </span>`;
            } else {
                return `<span class="badge bg-secondary" title="Precision unknown">
                    <i class="fas fa-question me-1"></i>N/A
                </span>`;
            }
        }
        
        return `<span class="badge bg-secondary">
            <i class="fas fa-question me-1"></i>N/A
        </span>`;
    }

    function showLoading(show) {
        document.getElementById('historyLoading').style.display = show ? 'block' : 'none';
    }

    function refreshHistory() {
        loadExecutionHistory();
    }

    function exportHistory() {
        const csvData = filteredExecutions.map(execution => ({
            'Execution ID': execution.execution_id,
            'Job Name': execution.job_name,
            'Job ID': execution.job_id,
            'Status': execution.status,
            'Start Time': execution.start_time,
            'End Time': execution.end_time || '',
            'Duration (seconds)': execution.duration_seconds || '',
            'Return Code': execution.return_code || '',
            'Error Message': execution.error_message || ''
        }));

        downloadCSV(csvData, 'job_execution_history.csv');
    }

    function downloadCSV(data, filename) {
        if (data.length === 0) return;
        
        const headers = Object.keys(data[0]);
        const csvContent = [
            headers.join(','),
            ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
        ].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        window.URL.revokeObjectURL(url);
    }

    function viewJobDetails(jobId) {
        window.location.href = `/jobs/${jobId}`;
    }

    function retryJob(jobId) {
        if (confirm('Are you sure you want to retry this job?')) {
            fetch(`/api/jobs/${jobId}/run`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showSuccess('Job retry initiated successfully');
                        setTimeout(loadExecutionHistory, 2000);
                    } else {
                        showError('Failed to retry job: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    showError('Error retrying job: ' + error.message);
                });
        }
    }

    function exportExecutionDetails() {
        const modalBody = document.getElementById('executionDetailsBody');
        if (!modalBody) return;
        
        // Create a simplified text version of the execution details
        const content = modalBody.innerText || modalBody.textContent || '';
        const blob = new Blob([content], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `execution_details_${Date.now()}.txt`;
        a.click();
        window.URL.revokeObjectURL(url);
    }

    function showSuccess(message) {
        // You can implement a toast notification here
        alert(message);
    }

    function showError(message) {
        // You can implement a toast notification here
        alert(message);
    }
    
    // Export query results to CSV
    function exportQueryResults(resultData) {
        if (!resultData || !resultData.columns || !resultData.rows) {
            showError('No data available to export');
            return;
        }
        
        try {
            // Create CSV content
            const headers = resultData.columns.join(',');
            const rows = resultData.rows.map(row => 
                row.map(cell => {
                    // Handle null/undefined values and escape quotes
                    const value = cell === null ? 'NULL' : 
                                 cell === undefined ? '' : 
                                 String(cell);
                    return `"${value.replace(/"/g, '""')}"`;
                }).join(',')
            ).join('\n');
            
            const csvContent = headers + '\n' + rows;
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `query_results_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccess(`Exported ${resultData.rows.length} rows to CSV`);
        } catch (error) {
            showError('Failed to export data: ' + error.message);
        }
    }
    
    // Toggle between table and raw JSON view
    function toggleResultsView(button) {
        const modal = button.closest('.modal-body');
        const tableView = modal.querySelector('.results-table-view');
        const rawView = modal.querySelector('.results-raw-view');
        
        if (tableView.style.display === 'none') {
            // Switch to table view
            tableView.style.display = 'block';
            rawView.style.display = 'none';
            button.innerHTML = '<i class="fas fa-list me-1"></i>Raw View';
            button.title = 'Switch to raw JSON view';
        } else {
            // Switch to raw view
            tableView.style.display = 'none';
            rawView.style.display = 'block';
            button.innerHTML = '<i class="fas fa-table me-1"></i>Table View';
            button.title = 'Switch to table view';
        }
    }
    
    // Show all results (for large result sets)
    function showAllResults(resultData) {
        if (!resultData || !resultData.rows) return;
        
        const confirmed = confirm(`This will display all ${resultData.rows.length} rows. This might slow down the browser. Continue?`);
        if (!confirmed) return;
        
        try {
            // Re-render with all rows
            const modal = document.querySelector('#executionDetailsModal .modal-body');
            const currentContent = modal.innerHTML;
            
            // Find and replace the results section with full data
            const tempData = {...resultData};
            tempData.show_all = true;
            
            // Re-generate the results section
            const newResultsHTML = renderQueryResults(tempData, true); // Pass showAll flag
            
            // Replace the results section in the modal
            const resultsSection = modal.querySelector('.mt-3');
            if (resultsSection) {
                resultsSection.outerHTML = newResultsHTML;
            }
            
            showSuccess(`Now showing all ${resultData.rows.length} rows`);
        } catch (error) {
            showError('Failed to display all results: ' + error.message);
        }
    }
    
    // Helper functions for operation type detection and styling
    function getOperationType(resultData) {
        // Try to detect operation type from context or query
        if (resultData.operation_type) {
            return resultData.operation_type.toUpperCase();
        }
        
        // Fallback: try to infer from rows_affected pattern
        const rowsAffected = resultData.rows_affected || 0;
        if (rowsAffected > 0) {
            return 'MODIFY'; // Could be INSERT, UPDATE, DELETE
        }
        return 'EXECUTE'; // Generic execution
    }
    
    function getOperationIcon(operationType) {
        const iconMap = {
            'INSERT': 'fas fa-plus-circle',
            'UPDATE': 'fas fa-edit',
            'DELETE': 'fas fa-trash-alt',
            'CREATE': 'fas fa-hammer',
            'DROP': 'fas fa-bomb',
            'ALTER': 'fas fa-wrench',
            'TRUNCATE': 'fas fa-broom',
            'MODIFY': 'fas fa-database',
            'EXECUTE': 'fas fa-play-circle'
        };
        return iconMap[operationType] || 'fas fa-database';
    }
    
    function getOperationColorClass(operationType) {
        const colorMap = {
            'INSERT': 'text-success',
            'UPDATE': 'text-warning',
            'DELETE': 'text-danger',
            'CREATE': 'text-info',
            'DROP': 'text-danger',
            'ALTER': 'text-warning',
            'TRUNCATE': 'text-danger',
            'MODIFY': 'text-primary',
            'EXECUTE': 'text-secondary'
        };
        return colorMap[operationType] || 'text-primary';
    }
    
    function getAlertClass(operationType) {
        const alertMap = {
            'INSERT': 'success',
            'UPDATE': 'warning',
            'DELETE': 'danger',
            'CREATE': 'info',
            'DROP': 'danger',
            'ALTER': 'warning',
            'TRUNCATE': 'warning',
            'MODIFY': 'primary',
            'EXECUTE': 'secondary'
        };
        return alertMap[operationType] || 'success';
    }
</script>
{% endblock %}