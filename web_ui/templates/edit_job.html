{% extends "base.html" %}

{% block title %}Edit Job - {{ job.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0"><i class="fas fa-edit me-2"></i>Edit Job</h4>
                        <small class="text-muted">{{ job.name }} ({{ job.job_type | upper }})</small>
                    </div>
                    <div>
                        <a href="{{ url_for('job_details', job_id=job.job_id) }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Back to Job
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="card-body">
                <form id="editJobForm">
                    <input type="hidden" id="jobId" value="{{ job.job_id }}">
                    
                    <!-- Basic Job Information -->
                    <div class="mb-4">
                        <h5><i class="fas fa-info-circle me-2"></i>Basic Information</h5>
                        
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="jobName" class="form-label">Job Name *</label>
                                    <input type="text" class="form-control" id="jobName" value="{{ job.name }}" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="jobType" class="form-label">Job Type</label>
                                    <input type="text" class="form-control" id="jobType" value="{{ job.job_type }}" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="jobDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="jobDescription" rows="3">{{ job.description or '' }}</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="jobEnabled" {{ 'checked' if job.enabled else '' }}>
                                <label class="form-check-label" for="jobEnabled">
                                    <strong>Job Enabled</strong>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Job Configuration -->
                    {% if job.job_type == 'sql' %}
                    <div class="mb-4">
                        <h5><i class="fas fa-database me-2"></i>SQL Configuration</h5>
                        
                        <div class="mb-3">
                            <label for="connectionName" class="form-label">Connection Name *</label>
                            <input type="text" class="form-control" id="connectionName" 
                                   value="{{ job.configuration.connection_name or '' }}" readonly>
                            <div class="form-text">Database connection (cannot be changed during edit)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="sqlQuery" class="form-label">SQL Query *</label>
                            <textarea class="form-control font-monospace" id="sqlQuery" rows="10" required>{{ job.configuration.sql_query or '' }}</textarea>
                        </div>
                    </div>
                    
                    {% elif job.job_type == 'powershell' %}
                    <div class="mb-4">
                        <h5><i class="fab fa-microsoft me-2"></i>PowerShell Configuration</h5>
                        
                        {% if job.configuration.script_content %}
                        <div class="mb-3">
                            <label for="scriptContent" class="form-label">Script Content *</label>
                            <textarea class="form-control font-monospace" id="scriptContent" rows="15" required>{{ job.configuration.script_content }}</textarea>
                        </div>
                        {% endif %}
                        
                        {% if job.configuration.script_path %}
                        <div class="mb-3">
                            <label for="scriptPath" class="form-label">Script Path *</label>
                            <input type="text" class="form-control" id="scriptPath" 
                                   value="{{ job.configuration.script_path }}" required>
                        </div>
                        {% endif %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="executionPolicy" class="form-label">Execution Policy</label>
                                    <select class="form-select" id="executionPolicy">
                                        <option value="RemoteSigned" {{ 'selected' if job.configuration.execution_policy == 'RemoteSigned' else '' }}>RemoteSigned</option>
                                        <option value="Unrestricted" {{ 'selected' if job.configuration.execution_policy == 'Unrestricted' else '' }}>Unrestricted</option>
                                        <option value="Bypass" {{ 'selected' if job.configuration.execution_policy == 'Bypass' else '' }}>Bypass</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="workingDirectory" class="form-label">Working Directory</label>
                                    <input type="text" class="form-control" id="workingDirectory" 
                                           value="{{ job.configuration.working_directory or '' }}"
                                           placeholder="C:\Scripts (optional)">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="parameters" class="form-label">Parameters</label>
                            <input type="text" class="form-control" id="parameters" 
                                   value="{{ job.configuration.parameters | join(' ') if job.configuration.parameters else '' }}"
                                   placeholder="-Verbose -Force">
                        </div>
                    </div>
                    {% endif %}

                    <!-- Schedule Configuration -->
                    <div class="mb-4">
                        <h5><i class="fas fa-calendar-alt me-2"></i>Schedule Configuration</h5>
                        
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enableSchedule" 
                                       {{ 'checked' if job.schedule_enabled else '' }}>
                                <label class="form-check-label" for="enableSchedule">
                                    <strong>Enable Scheduling</strong>
                                </label>
                            </div>
                        </div>

                        <div id="scheduleSection" style="{{ 'display: block;' if job.schedule_enabled else 'display: none;' }}">
                            <!-- Schedule Type -->
                            <div class="mb-3">
                                <label class="form-label">Schedule Type</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="scheduleType" id="scheduleTypeCron" value="cron" 
                                           {{ 'checked' if job.schedule_type == 'cron' else '' }}>
                                    <label class="btn btn-outline-secondary" for="scheduleTypeCron">
                                        <i class="fas fa-clock me-1"></i>Cron Expression
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="scheduleType" id="scheduleTypeInterval" value="interval"
                                           {{ 'checked' if job.schedule_type == 'interval' else '' }}>
                                    <label class="btn btn-outline-secondary" for="scheduleTypeInterval">
                                        <i class="fas fa-redo me-1"></i>Interval
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="scheduleType" id="scheduleTypeOnce" value="once"
                                           {{ 'checked' if job.schedule_type == 'once' else '' }}>
                                    <label class="btn btn-outline-secondary" for="scheduleTypeOnce">
                                        <i class="fas fa-calendar-day me-1"></i>One Time
                                    </label>
                                </div>
                            </div>

                            <!-- Timezone Selection -->
                            <div class="mb-3">
                                <label for="scheduleTimezone" class="form-label">
                                    <i class="fas fa-globe me-1"></i>Schedule Timezone
                                </label>
                                <select class="form-select" id="scheduleTimezone">
                                    <option value="UTC" {{ 'selected' if job.timezone == 'UTC' else '' }}>UTC (Coordinated Universal Time)</option>
                                    <optgroup label="America">
                                        <option value="America/New_York" {{ 'selected' if job.timezone == 'America/New_York' else '' }}>America/New_York (Eastern Time)</option>
                                        <option value="America/Chicago" {{ 'selected' if job.timezone == 'America/Chicago' else '' }}>America/Chicago (Central Time)</option>
                                        <option value="America/Denver" {{ 'selected' if job.timezone == 'America/Denver' else '' }}>America/Denver (Mountain Time)</option>
                                        <option value="America/Los_Angeles" {{ 'selected' if job.timezone == 'America/Los_Angeles' else '' }}>America/Los_Angeles (Pacific Time)</option>
                                        <option value="America/Phoenix" {{ 'selected' if job.timezone == 'America/Phoenix' else '' }}>America/Phoenix (MST - No DST)</option>
                                        <option value="America/Anchorage" {{ 'selected' if job.timezone == 'America/Anchorage' else '' }}>America/Anchorage (Alaska Time)</option>
                                        <option value="America/Toronto" {{ 'selected' if job.timezone == 'America/Toronto' else '' }}>America/Toronto (Eastern Canada)</option>
                                        <option value="America/Vancouver" {{ 'selected' if job.timezone == 'America/Vancouver' else '' }}>America/Vancouver (Pacific Canada)</option>
                                        <option value="America/Mexico_City" {{ 'selected' if job.timezone == 'America/Mexico_City' else '' }}>America/Mexico_City (CST)</option>
                                        <option value="America/Sao_Paulo" {{ 'selected' if job.timezone == 'America/Sao_Paulo' else '' }}>America/Sao_Paulo (Brazil)</option>
                                    </optgroup>
                                    <optgroup label="Europe">
                                        <option value="Europe/London" {{ 'selected' if job.timezone == 'Europe/London' else '' }}>Europe/London (GMT/BST)</option>
                                        <option value="Europe/Paris" {{ 'selected' if job.timezone == 'Europe/Paris' else '' }}>Europe/Paris (CET/CEST)</option>
                                        <option value="Europe/Berlin" {{ 'selected' if job.timezone == 'Europe/Berlin' else '' }}>Europe/Berlin (CET/CEST)</option>
                                        <option value="Europe/Rome" {{ 'selected' if job.timezone == 'Europe/Rome' else '' }}>Europe/Rome (CET/CEST)</option>
                                        <option value="Europe/Madrid" {{ 'selected' if job.timezone == 'Europe/Madrid' else '' }}>Europe/Madrid (CET/CEST)</option>
                                        <option value="Europe/Amsterdam" {{ 'selected' if job.timezone == 'Europe/Amsterdam' else '' }}>Europe/Amsterdam (CET/CEST)</option>
                                        <option value="Europe/Stockholm" {{ 'selected' if job.timezone == 'Europe/Stockholm' else '' }}>Europe/Stockholm (CET/CEST)</option>
                                        <option value="Europe/Moscow" {{ 'selected' if job.timezone == 'Europe/Moscow' else '' }}>Europe/Moscow (MSK)</option>
                                    </optgroup>
                                    <optgroup label="Asia">
                                        <option value="Asia/Tokyo" {{ 'selected' if job.timezone == 'Asia/Tokyo' else '' }}>Asia/Tokyo (JST)</option>
                                        <option value="Asia/Shanghai" {{ 'selected' if job.timezone == 'Asia/Shanghai' else '' }}>Asia/Shanghai (CST)</option>
                                        <option value="Asia/Hong_Kong" {{ 'selected' if job.timezone == 'Asia/Hong_Kong' else '' }}>Asia/Hong_Kong (HKT)</option>
                                        <option value="Asia/Singapore" {{ 'selected' if job.timezone == 'Asia/Singapore' else '' }}>Asia/Singapore (SGT)</option>
                                        <option value="Asia/Kolkata" {{ 'selected' if job.timezone == 'Asia/Kolkata' else '' }}>Asia/Kolkata (IST)</option>
                                        <option value="Asia/Dubai" {{ 'selected' if job.timezone == 'Asia/Dubai' else '' }}>Asia/Dubai (GST)</option>
                                        <option value="Asia/Seoul" {{ 'selected' if job.timezone == 'Asia/Seoul' else '' }}>Asia/Seoul (KST)</option>
                                        <option value="Asia/Bangkok" {{ 'selected' if job.timezone == 'Asia/Bangkok' else '' }}>Asia/Bangkok (ICT)</option>
                                    </optgroup>
                                    <optgroup label="Pacific">
                                        <option value="Australia/Sydney" {{ 'selected' if job.timezone == 'Australia/Sydney' else '' }}>Australia/Sydney (AEST/AEDT)</option>
                                        <option value="Australia/Melbourne" {{ 'selected' if job.timezone == 'Australia/Melbourne' else '' }}>Australia/Melbourne (AEST/AEDT)</option>
                                        <option value="Australia/Perth" {{ 'selected' if job.timezone == 'Australia/Perth' else '' }}>Australia/Perth (AWST)</option>
                                        <option value="Pacific/Auckland" {{ 'selected' if job.timezone == 'Pacific/Auckland' else '' }}>Pacific/Auckland (NZST/NZDT)</option>
                                        <option value="Pacific/Honolulu" {{ 'selected' if job.timezone == 'Pacific/Honolulu' else '' }}>Pacific/Honolulu (HST)</option>
                                    </optgroup>
                                </select>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    All schedules are stored in UTC. Local times are converted automatically with DST handling.
                                    <div id="timezoneInfo" class="mt-1 text-primary"></div>
                                </div>
                            </div>

                            <!-- Cron Expression -->
                            <div id="cronSection" style="{{ 'display: block;' if job.schedule_type == 'cron' else 'display: none;' }}">
                                <div class="mb-3">
                                    <label for="cronExpression" class="form-label">Cron Expression</label>
                                    <input type="text" class="form-control" id="cronExpression" 
                                           value="{{ job.schedule_expression or '' }}"
                                           placeholder="0 0 12 * * ? (daily at noon)">
                                    <div class="form-text">Format: second minute hour day month day_of_week</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Quick Presets</label>
                                    <div class="btn-group-vertical w-100">
                                        <button type="button" class="btn btn-outline-info btn-sm" onclick="setCronPreset('0 0 9 * * 1-5')">
                                            <i class="fas fa-business-time me-1"></i>Daily at 9 AM (Weekdays)
                                        </button>
                                        <button type="button" class="btn btn-outline-info btn-sm" onclick="setCronPreset('0 0 0 * * 0')">
                                            <i class="fas fa-calendar-week me-1"></i>Weekly (Sunday Midnight)
                                        </button>
                                        <button type="button" class="btn btn-outline-info btn-sm" onclick="setCronPreset('0 0 0 1 * ?')">
                                            <i class="fas fa-calendar me-1"></i>Monthly (1st of Month)
                                        </button>
                                        <button type="button" class="btn btn-outline-info btn-sm" onclick="setCronPreset('0 */15 * * * ?')">
                                            <i class="fas fa-clock me-1"></i>Every 15 Minutes
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Interval Schedule -->
                            <div id="intervalSection" style="{{ 'display: block;' if job.schedule_type == 'interval' else 'display: none;' }}">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label for="intervalDays" class="form-label">Days</label>
                                        <input type="number" class="form-control" id="intervalDays" min="0" value="0">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="intervalHours" class="form-label">Hours</label>
                                        <input type="number" class="form-control" id="intervalHours" min="0" max="23" value="0">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="intervalMinutes" class="form-label">Minutes</label>
                                        <input type="number" class="form-control" id="intervalMinutes" min="0" max="59" value="30">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="intervalSeconds" class="form-label">Seconds</label>
                                        <input type="number" class="form-control" id="intervalSeconds" min="0" max="59" value="0">
                                    </div>
                                </div>
                            </div>

                            <!-- One Time Schedule -->
                            <div id="onceSection" style="{{ 'display: block;' if job.schedule_type == 'once' else 'display: none;' }}">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="runDate" class="form-label">Run Date</label>
                                        <input type="date" class="form-control" id="runDate">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="runTime" class="form-label">Run Time</label>
                                        <input type="time" class="form-control" id="runTime">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Settings -->
                    <div class="mb-4">
                        <h5><i class="fas fa-cog me-2"></i>Advanced Settings</h5>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="timeout" class="form-label">Timeout (seconds)</label>
                                    <input type="number" class="form-control" id="timeout" 
                                           value="{{ job.timeout or 300 }}" min="1" max="3600">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="maxRetries" class="form-label">Max Retries</label>
                                    <input type="number" class="form-control" id="maxRetries" 
                                           value="{{ job.max_retries or 3 }}" min="0" max="10">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="retryDelay" class="form-label">Retry Delay (seconds)</label>
                                    <input type="number" class="form-control" id="retryDelay" 
                                           value="{{ job.retry_delay or 60 }}" min="1" max="3600">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <a href="{{ url_for('job_details', job_id=job.job_id) }}" class="btn btn-secondary">
                                <i class="fas fa-times me-1"></i>Cancel
                            </a>
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline-primary me-2" onclick="validateChanges()">
                                <i class="fas fa-check me-1"></i>Validate
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>Save Changes
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('editJobForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveJob();
    });

    function validateChanges() {
        const jobName = document.getElementById('jobName').value.trim();
        
        if (!jobName) {
            showError('Job name is required');
            return false;
        }
        
        // Job-specific validation
        const jobType = document.getElementById('jobType').value;
        if (jobType === 'sql') {
            const sqlQuery = document.getElementById('sqlQuery').value.trim();
            if (!sqlQuery) {
                showError('SQL query is required');
                return false;
            }
        } else if (jobType === 'powershell') {
            const scriptContent = document.getElementById('scriptContent');
            const scriptPath = document.getElementById('scriptPath');
            
            if (scriptContent && !scriptContent.value.trim()) {
                showError('PowerShell script content is required');
                return false;
            } else if (scriptPath && !scriptPath.value.trim()) {
                showError('PowerShell script path is required');
                return false;
            }
        }
        
        showSuccess('Validation passed!');
        return true;
    }

    function saveJob() {
        if (!validateChanges()) {
            return;
        }
        
        showLoading();
        
        const jobId = document.getElementById('jobId').value;
        const jobType = document.getElementById('jobType').value;
        
        // Collect form data
        const jobData = {
            name: document.getElementById('jobName').value.trim(),
            description: document.getElementById('jobDescription').value.trim(),
            enabled: document.getElementById('jobEnabled').checked,
            timeout: parseInt(document.getElementById('timeout').value),
            max_retries: parseInt(document.getElementById('maxRetries').value),
            retry_delay: parseInt(document.getElementById('retryDelay').value)
        };

        // Add job-specific fields
        if (jobType === 'sql') {
            jobData.sql_query = document.getElementById('sqlQuery').value;
            jobData.connection_name = document.getElementById('connectionName').value;
        } else if (jobType === 'powershell') {
            const scriptContent = document.getElementById('scriptContent');
            const scriptPath = document.getElementById('scriptPath');
            
            if (scriptContent) {
                jobData.script_content = scriptContent.value;
            }
            if (scriptPath) {
                jobData.script_path = scriptPath.value;
            }
            
            jobData.execution_policy = document.getElementById('executionPolicy').value;
            jobData.working_directory = document.getElementById('workingDirectory').value;
            
            const params = document.getElementById('parameters').value.trim();
            if (params) {
                jobData.parameters = params.split(' ').filter(p => p.trim());
            }
        }

        // Add schedule configuration
        const scheduleEnabled = document.getElementById('enableSchedule').checked;
        if (scheduleEnabled) {
            const scheduleType = document.querySelector('input[name="scheduleType"]:checked')?.value;
            const timezone = document.getElementById('scheduleTimezone').value;
            
            jobData.schedule_enabled = true;
            jobData.schedule_type = scheduleType;
            jobData.timezone = timezone;
            
            if (scheduleType === 'cron') {
                jobData.schedule_expression = document.getElementById('cronExpression').value;
            } else if (scheduleType === 'interval') {
                // For interval, we might need to format it differently
                const days = parseInt(document.getElementById('intervalDays').value) || 0;
                const hours = parseInt(document.getElementById('intervalHours').value) || 0;
                const minutes = parseInt(document.getElementById('intervalMinutes').value) || 0;
                const seconds = parseInt(document.getElementById('intervalSeconds').value) || 0;
                
                // Store interval as expression for now
                jobData.schedule_expression = `${days}d ${hours}h ${minutes}m ${seconds}s`;
            } else if (scheduleType === 'once') {
                const date = document.getElementById('runDate').value;
                const time = document.getElementById('runTime').value;
                if (date && time) {
                    jobData.schedule_expression = `${date}T${time}:00`;
                }
            }
        } else {
            jobData.schedule_enabled = false;
            jobData.schedule_type = null;
            jobData.schedule_expression = null;
            jobData.timezone = 'UTC';
        }

        // Save via API
        fetch(`/api/jobs/${jobId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(jobData)
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showSuccess('Job updated successfully!');
                setTimeout(() => {
                    window.location.href = `/jobs/${jobId}`;
                }, 2000);
            } else {
                showError(data.error || 'Failed to update job');
            }
        })
        .catch(error => {
            hideLoading();
            showError('Error updating job: ' + error.message);
        });
    }

    function showLoading() {
        // Disable form and show loading state
        document.getElementById('editJobForm').style.opacity = '0.6';
        document.querySelectorAll('button, input, textarea, select').forEach(el => {
            el.disabled = true;
        });
    }

    function hideLoading() {
        // Re-enable form
        document.getElementById('editJobForm').style.opacity = '1';
        document.querySelectorAll('button, input, textarea, select').forEach(el => {
            el.disabled = false;
        });
    }

    function showSuccess(message) {
        alert('[SUCCESS] ' + message);
    }

    function showError(message) {
        alert('[ERROR] ' + message);
    }

    // Schedule handling functions
    document.addEventListener('DOMContentLoaded', function() {
        // Populate schedule fields with correct values
        populateScheduleFields();
        
        // Schedule toggle
        document.getElementById('enableSchedule').addEventListener('change', function() {
            const scheduleSection = document.getElementById('scheduleSection');
            scheduleSection.style.display = this.checked ? 'block' : 'none';
        });

        // Schedule type radios
        document.querySelectorAll('input[name="scheduleType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const cronSection = document.getElementById('cronSection');
                const intervalSection = document.getElementById('intervalSection');
                const onceSection = document.getElementById('onceSection');
                
                // Hide all sections
                cronSection.style.display = 'none';
                intervalSection.style.display = 'none';
                onceSection.style.display = 'none';
                
                // Show selected section
                if (this.value === 'cron') {
                    cronSection.style.display = 'block';
                } else if (this.value === 'interval') {
                    intervalSection.style.display = 'block';
                } else if (this.value === 'once') {
                    onceSection.style.display = 'block';
                }
            });
        });

        // Timezone change handler
        document.getElementById('scheduleTimezone').addEventListener('change', updateTimezoneInfo);
        
        // Initialize timezone info
        updateTimezoneInfo();
    });

    function populateScheduleFields() {
        // Get job schedule data from the server-side template
        const scheduleType = '{{ job.schedule_type or "" }}';
        const scheduleExpression = '{{ job.schedule_expression or "" }}';
        
        console.log('Populating schedule fields:', { scheduleType, scheduleExpression });
        
        if (scheduleType === 'interval' && scheduleExpression) {
            // Parse interval expression like "1d 2h 30m 15s"
            const parts = scheduleExpression.split(' ');
            
            for (const part of parts) {
                if (part.endsWith('d')) {
                    document.getElementById('intervalDays').value = parseInt(part.replace('d', '')) || 0;
                } else if (part.endsWith('h')) {
                    document.getElementById('intervalHours').value = parseInt(part.replace('h', '')) || 0;
                } else if (part.endsWith('m')) {
                    document.getElementById('intervalMinutes').value = parseInt(part.replace('m', '')) || 0;
                } else if (part.endsWith('s')) {
                    document.getElementById('intervalSeconds').value = parseInt(part.replace('s', '')) || 0;
                }
            }
        } else if (scheduleType === 'once' && scheduleExpression) {
            // Parse datetime expression like "2024-01-15T14:30:00"
            if (scheduleExpression.includes('T')) {
                const [date, timeWithSeconds] = scheduleExpression.split('T');
                const time = timeWithSeconds.split(':').slice(0, 2).join(':'); // Remove seconds
                
                document.getElementById('runDate').value = date;
                document.getElementById('runTime').value = time;
            }
        }
    }

    function setCronPreset(expression) {
        document.getElementById('cronExpression').value = expression;
    }

    function updateTimezoneInfo() {
        const timezone = document.getElementById('scheduleTimezone').value;
        const infoDiv = document.getElementById('timezoneInfo');
        
        try {
            const now = new Date();
            const localTime = now.toLocaleString('en-US', { 
                timeZone: timezone,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
            
            // Calculate UTC offset
            const localDate = new Date(now.toLocaleString('en-US', { timeZone: timezone }));
            const utcDate = new Date(now.toLocaleString('en-US', { timeZone: 'UTC' }));
            const offsetMs = localDate.getTime() - utcDate.getTime();
            const offsetHours = offsetMs / (1000 * 60 * 60);
            const offsetSign = offsetHours >= 0 ? '+' : '';
            
            infoDiv.innerHTML = `
                <small>
                    <strong>Current time:</strong> ${localTime} (UTC${offsetSign}${offsetHours})
                </small>
            `;
        } catch (error) {
            infoDiv.innerHTML = `<small class="text-warning">Timezone information not available</small>`;
        }
    }
</script>
{% endblock %}