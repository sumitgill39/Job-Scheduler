{% extends "base.html" %}

{% block title %}Edit Job - Windows Job Scheduler{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">
                        <i class="fas fa-edit me-2"></i>Edit Job
                    </h4>
                    <small class="text-muted">Modify existing job configuration</small>
                </div>
                <div>
                    <a href="{{ url_for('job_list') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Jobs
                    </a>
                </div>
            </div>
            
            <div class="card-body">
                <form id="editJobForm">
                    <input type="hidden" id="jobId" name="job_id" value="">
                    
                    <!-- Job Information Section -->
                    <div class="mb-4">
                        <h5 class="border-bottom pb-2">
                            <i class="fas fa-info-circle me-2"></i>Job Information
                        </h5>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="jobName" class="form-label">Job Name *</label>
                                    <input type="text" class="form-control" id="jobName" name="name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="jobType" class="form-label">Job Type</label>
                                    <input type="text" class="form-control" id="jobType" name="job_type" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="jobDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="jobDescription" name="description" rows="3"></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="jobEnabled" name="enabled">
                                        <label class="form-check-label" for="jobEnabled">
                                            <strong>Job Enabled</strong>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SQL Job Configuration -->
                    <div id="sqlJobConfig" style="display: none;">
                        <h5 class="border-bottom pb-2">
                            <i class="fas fa-database me-2"></i>SQL Configuration
                        </h5>
                        
                        <div class="mb-3">
                            <label for="connectionName" class="form-label">Database Connection *</label>
                            <input type="text" class="form-control" id="connectionName" name="connection_name" 
                                   placeholder="Connection name" readonly>
                            <div class="form-text">Connection name used by this job (cannot be changed during edit)</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="sqlQuery" class="form-label">SQL Query *</label>
                            <textarea class="form-control" id="sqlQuery" name="sql_query" rows="8" 
                                      placeholder="Enter your SQL query here..."></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="queryTimeout" class="form-label">Query Timeout (seconds)</label>
                                    <input type="number" class="form-control" id="queryTimeout" name="query_timeout" value="300" min="1">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="maxRows" class="form-label">Max Rows</label>
                                    <input type="number" class="form-control" id="maxRows" name="max_rows" value="1000" min="1">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PowerShell Job Configuration -->
                    <div id="powershellJobConfig" style="display: none;">
                        <h5 class="border-bottom pb-2">
                            <i class="fab fa-microsoft me-2"></i>PowerShell Configuration
                        </h5>
                        
                        <div class="mb-3">
                            <label class="form-label">Script Type</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="scriptType" id="scriptTypeInline" value="inline" checked>
                                <label class="btn btn-outline-primary" for="scriptTypeInline">
                                    <i class="fas fa-edit me-1"></i>Inline Script
                                </label>
                                
                                <input type="radio" class="btn-check" name="scriptType" id="scriptTypeFile" value="file">
                                <label class="btn btn-outline-primary" for="scriptTypeFile">
                                    <i class="fas fa-file me-1"></i>Script File
                                </label>
                            </div>
                        </div>

                        <div id="inlineScriptSection">
                            <div class="mb-3">
                                <label for="scriptContent" class="form-label">PowerShell Script *</label>
                                <textarea class="form-control" id="scriptContent" name="script_content" rows="8" 
                                          placeholder="Enter your PowerShell script here..."></textarea>
                            </div>
                        </div>

                        <div id="fileScriptSection" style="display: none;">
                            <div class="mb-3">
                                <label for="scriptPath" class="form-label">Script File Path *</label>
                                <input type="text" class="form-control" id="scriptPath" name="script_path" 
                                       placeholder="C:\Scripts\MyScript.ps1">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <label for="executionPolicy" class="form-label">Execution Policy</label>
                                <select class="form-select" id="executionPolicy" name="execution_policy">
                                    <option value="RemoteSigned">RemoteSigned</option>
                                    <option value="Unrestricted">Unrestricted</option>
                                    <option value="Bypass">Bypass</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="workingDirectory" class="form-label">Working Directory</label>
                                <input type="text" class="form-control" id="workingDirectory" name="working_directory" 
                                       placeholder="C:\Scripts (optional)">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="scriptParameters" class="form-label">Parameters</label>
                            <input type="text" class="form-control" id="scriptParameters" name="parameters" 
                                   placeholder="-Message 'Hello World' -Verbose">
                        </div>
                    </div>

                    <!-- Advanced Settings -->
                    <div class="mb-4">
                        <h5 class="border-bottom pb-2">
                            <i class="fas fa-cog me-2"></i>Advanced Settings
                        </h5>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="jobTimeout" class="form-label">Timeout (seconds)</label>
                                    <input type="number" class="form-control" id="jobTimeout" name="timeout" value="300" min="1">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="maxRetries" class="form-label">Max Retries</label>
                                    <input type="number" class="form-control" id="maxRetries" name="max_retries" value="3" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="retryDelay" class="form-label">Retry Delay (seconds)</label>
                                    <input type="number" class="form-control" id="retryDelay" name="retry_delay" value="60" min="1">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="runAs" class="form-label">Run As (optional)</label>
                            <input type="text" class="form-control" id="runAs" name="run_as" 
                                   placeholder="domain\username (leave empty for current user)">
                        </div>
                    </div>

                    <!-- Schedule Configuration (Read-Only) -->
                    <div class="mb-4">
                        <h5 class="border-bottom pb-2">
                            <i class="fas fa-clock me-2"></i>Schedule Configuration
                            <small class="text-muted ms-2">(Read-Only)</small>
                        </h5>
                        
                        <!-- Security Notice -->
                        <div class="alert alert-warning" role="alert">
                            <i class="fas fa-shield-alt me-2"></i>
                            <strong>Security Notice:</strong> Due to security and audit purposes, it is not recommended to update existing schedules. 
                            If you need to modify the schedule, please <strong>create a fresh job</strong> with the new schedule configuration.
                        </div>
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="enableSchedule" name="enable_schedule" disabled>
                            <label class="form-check-label" for="enableSchedule">
                                <strong>Enable Scheduling</strong> 
                                <span class="text-muted">(Cannot be modified)</span>
                            </label>
                        </div>
                        
                        <!-- Schedule Information (Read-Only Display) -->
                        <div id="scheduleSection">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-info-circle me-2"></i>Current Schedule Configuration
                                    </h6>
                                    <div id="scheduleDisplayInfo" class="text-muted">
                                        <p class="mb-1"><strong>Status:</strong> <span id="scheduleStatusDisplay">Not scheduled</span></p>
                                        <p class="mb-1"><strong>Type:</strong> <span id="scheduleTypeDisplay">-</span></p>
                                        <p class="mb-1"><strong>Configuration:</strong> <span id="scheduleConfigDisplay">-</span></p>
                                        <p class="mb-0"><strong>Timezone:</strong> <span id="scheduleTimezoneDisplay">-</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between">
                        <div>
                            <a href="{{ url_for('job_list') }}" class="btn btn-secondary">
                                <i class="fas fa-times me-1"></i>Cancel
                            </a>
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline-info me-2" onclick="previewChanges()">
                                <i class="fas fa-eye me-1"></i>Preview Changes
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>Save Changes
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let currentJobData = {};
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        const jobId = getJobIdFromURL();
        if (jobId) {
            // Just load job data since connection is now a text field
            loadJobData(jobId).then(() => {
                setupEventListeners();
            }).catch(error => {
                console.error('Error loading data:', error);
                showError('Failed to load job data');
            });
        } else {
            showError('No job ID provided');
            setTimeout(() => window.location.href = '/jobs', 2000);
        }
    });

    function getJobIdFromURL() {
        const pathParts = window.location.pathname.split('/');
        return pathParts[pathParts.length - 2]; // Assuming URL is /jobs/{id}/edit
    }

    function loadJobData(jobId) {
        console.log('Loading job data for:', jobId); // Debug log
        
        return fetch(`/api/jobs/${jobId}`)
            .then(response => response.json())
            .then(data => {
                console.log('API Response:', data); // Debug log
                if (data.success && data.job) {
                    currentJobData = data.job;
                    console.log('Job Data:', data.job); // Debug log
                    populateForm(data.job);
                    return data.job;
                } else {
                    throw new Error(data.error || 'Failed to load job data');
                }
            })
            .catch(error => {
                showError('Error loading job: ' + error.message);
                throw error;
            });
    }

    function populateForm(job) {
        console.log('=================== POPULATE FORM DEBUG ===================');
        console.log('Full job object:', JSON.stringify(job, null, 2));
        console.log('Job type:', job.job_type);
        console.log('Configuration object:', JSON.stringify(job.configuration, null, 2));
        
        // Basic job information
        document.getElementById('jobId').value = job.job_id;
        document.getElementById('jobName').value = job.name || '';
        document.getElementById('jobType').value = job.job_type || '';
        document.getElementById('jobDescription').value = job.description || '';
        document.getElementById('jobEnabled').checked = job.enabled;

        // Parse configuration
        const config = job.configuration || {};
        const basic = config.basic || {};
        
        console.log('Basic config:', basic); // Debug log
        
        // Advanced settings
        document.getElementById('jobTimeout').value = basic.timeout || 300;
        document.getElementById('maxRetries').value = basic.max_retries || 3;
        document.getElementById('retryDelay').value = basic.retry_delay || 60;
        document.getElementById('runAs').value = basic.run_as || '';

        // Job-specific configuration
        if (job.job_type === 'sql') {
            console.log('Loading SQL job configuration'); // Debug log
            showSQLConfig();
            const sqlConfig = config.sql || {};
            console.log('SQL config:', sqlConfig); // Debug log
            
            // Set the connection name directly in the text field
            document.getElementById('connectionName').value = sqlConfig.connection_name || '';
            document.getElementById('sqlQuery').value = sqlConfig.query || '';
            document.getElementById('queryTimeout').value = sqlConfig.query_timeout || 300;
            document.getElementById('maxRows').value = sqlConfig.max_rows || 1000;
        } else if (job.job_type === 'powershell') {
            console.log('Loading PowerShell job configuration'); // Debug log
            showPowerShellConfig();
            
            console.log('Job script_content:', job.script_content); // Debug log
            console.log('Job script_path:', job.script_path); // Debug log
            console.log('Job execution_policy:', job.execution_policy); // Debug log
            
            // Determine script type - use direct job fields
            if (job.script_content && job.script_content.trim() !== '') {
                document.getElementById('scriptTypeInline').checked = true;
                document.getElementById('scriptContent').value = job.script_content;
                showInlineScriptSection();
                console.log('Set inline script content'); // Debug log
            } else if (job.script_path && job.script_path.trim() !== '') {
                document.getElementById('scriptTypeFile').checked = true;
                document.getElementById('scriptPath').value = job.script_path;
                showFileScriptSection();
                console.log('Set script file path'); // Debug log
            } else {
                // Default to inline if neither is set
                document.getElementById('scriptTypeInline').checked = true;
                showInlineScriptSection();
                console.log('Defaulted to inline script (no content found)'); // Debug log
            }
            
            document.getElementById('executionPolicy').value = job.execution_policy || 'RemoteSigned';
            document.getElementById('workingDirectory').value = job.working_directory || '';
            
            // Handle parameters - use direct job field
            if (job.parameters) {
                if (Array.isArray(job.parameters)) {
                    document.getElementById('scriptParameters').value = job.parameters.join(' ');
                } else if (typeof job.parameters === 'string') {
                    document.getElementById('scriptParameters').value = job.parameters;
                }
            }
        }

        // Schedule configuration
        console.log('=================== SCHEDULE DEBUG ===================');
        console.log('Full config object for schedule lookup:', JSON.stringify(config, null, 2));
        console.log('config.schedule:', JSON.stringify(config.schedule, null, 2));
        console.log('Direct job schedule fields:', {
            schedule_enabled: job.schedule_enabled,
            schedule_type: job.schedule_type,
            cron_expression: job.cron_expression,
            schedule_timezone: job.schedule_timezone
        });
        
        // Check for schedule in config first, then fall back to direct job fields
        const scheduleFromConfig = config.schedule;
        const scheduleFromJob = job.schedule_enabled;
        
        if (scheduleFromConfig || scheduleFromJob) {
            console.log('✅ Schedule found, displaying schedule information');
            document.getElementById('enableSchedule').checked = true;
            
            // Use config.schedule if available, otherwise use direct job fields
            const schedule = scheduleFromConfig || {};
            const scheduleType = schedule.type || job.schedule_type || 'cron';
            const timezoneValue = schedule.timezone || job.schedule_timezone || 'UTC';
            
            console.log('Schedule object:', JSON.stringify(schedule, null, 2));
            console.log('Schedule type detected:', scheduleType);
            
            // Populate read-only display
            document.getElementById('scheduleStatusDisplay').textContent = 'Scheduled';
            document.getElementById('scheduleTypeDisplay').textContent = scheduleType.charAt(0).toUpperCase() + scheduleType.slice(1);
            document.getElementById('scheduleTimezoneDisplay').textContent = timezoneValue;
            
            let configDisplay = '';
            if (scheduleType === 'cron') {
                const cronExpression = schedule.cron || schedule.expression || job.cron_expression || '0 0 * * *';
                configDisplay = `Cron: ${cronExpression}`;
                console.log('Displaying cron schedule:', cronExpression);
            } else if (scheduleType === 'interval') {
                const interval = schedule.interval || {};
                const days = interval.days || 0;
                const hours = interval.hours || 0;
                const minutes = interval.minutes || 0;
                const seconds = interval.seconds || 0;
                configDisplay = `Every ${days}d ${hours}h ${minutes}m ${seconds}s`;
                console.log('Displaying interval schedule:', interval);
            } else if (scheduleType === 'date') {
                const runDate = schedule.run_date || 'Not set';
                configDisplay = `Run once at: ${runDate}`;
                console.log('Displaying date schedule:', runDate);
            }
            
            document.getElementById('scheduleConfigDisplay').textContent = configDisplay;
            
        } else {
            console.log('❌ No schedule configuration found');
            document.getElementById('scheduleStatusDisplay').textContent = 'Not scheduled';
            document.getElementById('scheduleTypeDisplay').textContent = '-';
            document.getElementById('scheduleConfigDisplay').textContent = '-';
            document.getElementById('scheduleTimezoneDisplay').textContent = '-';
        }
    }

    // Connection loading functions removed since connection is now a text field

    function setupEventListeners() {
        // Script type radios
        document.querySelectorAll('input[name="scriptType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'inline') {
                    showInlineScriptSection();
                } else {
                    showFileScriptSection();
                }
            });
        });

        // Form submission
        document.getElementById('editJobForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveJobChanges();
        });
    }

    function showSQLConfig() {
        document.getElementById('sqlJobConfig').style.display = 'block';
        document.getElementById('powershellJobConfig').style.display = 'none';
    }

    function showPowerShellConfig() {
        document.getElementById('sqlJobConfig').style.display = 'none';
        document.getElementById('powershellJobConfig').style.display = 'block';
    }


    function showInlineScriptSection() {
        document.getElementById('inlineScriptSection').style.display = 'block';
        document.getElementById('fileScriptSection').style.display = 'none';
    }

    function showFileScriptSection() {
        document.getElementById('inlineScriptSection').style.display = 'none';
        document.getElementById('fileScriptSection').style.display = 'block';
    }

    function previewChanges() {
        if (confirm('Do you want to save the changes to this job?')) {
            saveJobChanges();
        }
    }


    function saveJobChanges() {
        try {
            // Get required job data
            const jobId = document.getElementById('jobId').value;
            const jobName = document.getElementById('jobName').value;
            const jobType = document.getElementById('jobType').value;
            
            // Build job data object
            const jobData = {
                job_id: jobId,
                name: jobName,
                job_type: jobType,
                description: document.getElementById('jobDescription').value,
                enabled: document.getElementById('jobEnabled').checked
            };
            
            // Add type-specific fields
            if (jobType === 'powershell') {
                const scriptType = document.querySelector('input[name="scriptType"]:checked')?.value || 'inline';
                if (scriptType === 'inline') {
                    jobData.script_content = document.getElementById('scriptContent').value;
                } else {
                    jobData.script_path = document.getElementById('scriptPath').value;
                }
                jobData.execution_policy = document.getElementById('executionPolicy').value;
                jobData.working_directory = document.getElementById('workingDirectory').value;
            } else if (jobType === 'sql') {
                jobData.sql_query = document.getElementById('sqlQuery').value;
                jobData.connection_name = document.getElementById('connectionName').value;
            }
            
            fetch(`/api/jobs/${jobId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(jobData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('Job updated successfully!');
                    setTimeout(() => {
                        window.location.href = `/jobs/${jobId}`;
                    }, 2000);
                } else {
                    showError(data.error || 'Failed to update job');
                }
            })
            .catch(error => {
                showError('Error updating job: ' + error.message);
            });
        } catch (error) {
            console.error('Error in saveJobChanges:', error);
            showError('JavaScript error: ' + error.message);
        }
    }
    
    function showSuccess(message) {
        // Create a simple alert for now - can be enhanced with toast notifications
        alert('✅ ' + message);
    }
    
    function showError(message) {
        // Create a simple alert for now - can be enhanced with toast notifications  
        alert('❌ ' + message);
    }
    

</script>
{% endblock %}