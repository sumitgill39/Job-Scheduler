{% extends "base.html" %}

{% block title %}Database Connections - Windows Job Scheduler{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-body py-2">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-database me-2 text-primary"></i>
                            <span class="fw-bold">System Database:</span>
                            <span id="system-db-status" class="badge bg-secondary ms-2">Checking...</span>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="validateAllConnections()">
                            <i class="fas fa-check-double me-1"></i>Validate All
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="loadConnections()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#connectionModal">
                            <i class="fas fa-plus me-1"></i>New Connection
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>
                    Database Connections
                    <span id="connection-count" class="badge bg-secondary ms-2">0</span>
                </h5>
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <small class="text-muted me-2">Status:</small>
                        <span id="valid-count" class="badge bg-success">0 Valid</span>
                        <span id="invalid-count" class="badge bg-danger">0 Invalid</span>
                        <span id="pending-count" class="badge bg-warning">0 Pending</span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Loading indicator -->
                <div id="loading-connections" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading connections...</span>
                    </div>
                    <div class="mt-2">Loading connections from database...</div>
                </div>
                
                <!-- Connections table -->
                <div id="connections-container">
                    <div class="table-responsive">
                        <table class="table table-hover connection-table-optimized" id="connections-table">
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>Name</th>
                                    <th>Server</th>
                                    <th>Database</th>
                                    <th>Authentication</th>
                                    <th>Response Time</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="connections-tbody">
                                <!-- Connections will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Empty state -->
                <div id="empty-state" class="text-center py-5" style="display: none;">
                    <i class="fas fa-database fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No Database Connections Found</h4>
                    <p class="text-muted mb-4">Get started by creating your first database connection.</p>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#connectionModal">
                        <i class="fas fa-plus me-1"></i>Create First Connection
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Validation Logs Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-file-alt me-2"></i>
                    Validation Logs
                    <span id="log-count" class="badge bg-secondary ms-2">0 entries</span>
                </h5>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearValidationLogs()">
                        <i class="fas fa-trash me-1"></i>Clear Logs
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="exportValidationLogs()">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="validation-logs" class="validation-logs-container">
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-info-circle me-2"></i>
                        Validation logs will appear here when connections are tested
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Connection Modal -->
<div class="modal fade" id="connectionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Create New Database Connection
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="connectionForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="connName" class="form-label">Connection Name *</label>
                                <input type="text" class="form-control" id="connName" required>
                                <div class="form-text">Unique name for this connection</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="connDescription" class="form-label">Description</label>
                                <input type="text" class="form-control" id="connDescription">
                                <div class="form-text">Optional description</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="connServer" class="form-label">Server Name/IP *</label>
                                <input type="text" class="form-control" id="connServer" required
                                       placeholder="e.g., localhost, 192.168.1.100, SERVER\INSTANCE">
                                <div class="form-text">Server name, IP address, or named instance</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="connPort" class="form-label">Port</label>
                                <input type="number" class="form-control" id="connPort" value="1433" min="1" max="65535">
                                <div class="form-text">Default: 1433</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="connDatabase" class="form-label">Database Name *</label>
                                <input type="text" class="form-control" id="connDatabase" required>
                                <div class="form-text">Target database name</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="connAuth" class="form-label">Authentication</label>
                                <select class="form-select" id="connAuth">
                                    <option value="windows">Windows Authentication</option>
                                    <option value="sql">SQL Server Authentication</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SQL Authentication Section -->
                    <div id="connSqlAuth" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="connUsername" class="form-label">Username *</label>
                                    <input type="text" class="form-control" id="connUsername">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="connPassword" class="form-label">Password *</label>
                                    <input type="password" class="form-control" id="connPassword">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="testConnectionForm()">
                    <i class="fas fa-plug me-1"></i>Test Connection
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveConnection()">
                    <i class="fas fa-save me-1"></i>Save Connection
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.validation-logs-container {
    background: #f8f9fa;
    border-radius: 5px;
    min-height: 150px;
}

.validation-logs-content {
    background: white;
    border-radius: 5px;
    border: 1px solid #dee2e6;
}

.log-entry {
    transition: background-color 0.2s ease;
}

.log-entry:hover {
    background-color: #f8f9fa;
}

.log-message {
    font-size: 0.9em;
    line-height: 1.4;
    word-wrap: break-word;
}

.connection-table-optimized {
    table-layout: fixed;
}

.connection-table-optimized th:nth-child(1) { width: 10%; }
.connection-table-optimized th:nth-child(2) { width: 20%; }
.connection-table-optimized th:nth-child(3) { width: 20%; }
.connection-table-optimized th:nth-child(4) { width: 15%; }
.connection-table-optimized th:nth-child(5) { width: 12%; }
.connection-table-optimized th:nth-child(6) { width: 10%; }
.connection-table-optimized th:nth-child(7) { width: 13%; }

.fast-loading-indicator {
    border-left: 4px solid #007bff;
    background: #e7f3ff;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 4px;
}
</style>
{% endblock %}

{% block scripts %}
<script>
    let connectionStatuses = {};
    
    // Authentication type handling
    document.getElementById('connAuth').addEventListener('change', function() {
        const sqlAuthSection = document.getElementById('connSqlAuth');
        if (this.value === 'sql') {
            sqlAuthSection.style.display = 'block';
            document.getElementById('connUsername').required = true;
            document.getElementById('connPassword').required = true;
        } else {
            sqlAuthSection.style.display = 'none';
            document.getElementById('connUsername').required = false;
            document.getElementById('connPassword').required = false;
        }
    });
    
    // Load connections from database (optimized for speed)
    function loadConnections() {
        showElement('loading-connections');
        hideElement('connections-container');
        hideElement('empty-state');
        
        // Use faster endpoint that doesn't test connections immediately
        fetch('/api/connections?fast=true')
            .then(response => response.json())
            .then(data => {
                hideElement('loading-connections');
                
                if (data.success && data.connections && data.connections.length > 0) {
                    displayConnections(data.connections);
                    showElement('connections-container');
                    
                    // Auto-validate all connections after loading (Issue 2 fix)
                    setTimeout(() => {
                        validateAllConnectionsWithLogs();
                    }, 500); // Small delay to let UI render
                } else {
                    showElement('empty-state');
                }
            })
            .catch(error => {
                console.error('Error loading connections:', error);
                hideElement('loading-connections');
                showError('Failed to load connections from database');
                showElement('empty-state');
            });
    }
    
    // Display connections in table
    function displayConnections(connections) {
        const tbody = document.getElementById('connections-tbody');
        tbody.innerHTML = '';
        
        updateConnectionCounts(connections.length, 0, 0, connections.length);
        
        connections.forEach(conn => {
            const row = createConnectionRow(conn);
            tbody.appendChild(row);
            connectionStatuses[conn.name] = 'pending';
        });
    }
    
    // Create table row for connection
    function createConnectionRow(conn) {
        const row = document.createElement('tr');
        row.id = `conn-row-${conn.name}`;
        
        row.innerHTML = `
            <td>
                <span id="status-${conn.name}" class="badge bg-warning">
                    <i class="fas fa-clock me-1"></i>Pending
                </span>
            </td>
            <td>
                <strong>${conn.name}</strong>
                ${conn.description ? `<br><small class="text-muted">${conn.description}</small>` : ''}
            </td>
            <td>${conn.server}${conn.port && conn.port != 1433 ? ':' + conn.port : ''}</td>
            <td>${conn.database}</td>
            <td>${conn.auth_type}</td>
            <td>
                <span id="time-${conn.name}" class="text-muted">-</span>
            </td>
            <td>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-primary"
                            onclick="testSingleConnection('${conn.name}')"
                            data-bs-toggle="tooltip" title="Test Connection">
                        <i class="fas fa-plug"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger"
                            onclick="deleteConnection('${conn.name}')"
                            data-bs-toggle="tooltip" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        
        return row;
    }
    
    // Update connection counts
    function updateConnectionCounts(total, valid, invalid, pending) {
        document.getElementById('connection-count').textContent = total;
        document.getElementById('valid-count').textContent = `${valid} Valid`;
        document.getElementById('invalid-count').textContent = `${invalid} Invalid`;
        document.getElementById('pending-count').textContent = `${pending} Pending`;
    }
    
    // Validate all connections with detailed logging
    function validateAllConnectionsWithLogs() {
        // Add log entry for validation start
        addValidationLog('info', 'BULK_VALIDATION_START', 'Starting bulk validation of all connections...');
        
        // Update UI to show validation in progress
        showValidationProgress();
        
        fetch('/api/connections/validate-all-detailed', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            hideValidationProgress();
            
            if (data.success) {
                updateConnectionStatuses(data.results);
                updateConnectionCounts(
                    data.total_connections,
                    data.valid_connections,
                    data.invalid_connections,
                    0
                );
                
                // Log detailed results for each connection
                Object.entries(data.results).forEach(([connName, result]) => {
                    if (result.success) {
                        addValidationLog('success', connName, 
                            `Connection validated successfully. Response time: ${result.response_time.toFixed(2)}s, Server: ${result.server_info || 'N/A'}`);
                    } else {
                        addValidationLog('error', connName, 
                            `Connection validation failed: ${result.error}. Details: ${result.error_details || 'No additional details'}`);
                    }
                });
                
                addValidationLog('info', 'BULK_VALIDATION_COMPLETE', 
                    `Bulk validation completed. ${data.valid_connections} valid, ${data.invalid_connections} invalid out of ${data.total_connections} total connections.`);
                
                showSuccess(`Validated ${data.total_connections} connections: ${data.valid_connections} valid, ${data.invalid_connections} invalid`);
            } else {
                addValidationLog('error', 'BULK_VALIDATION_ERROR', `Bulk validation failed: ${data.error}`);
                showError('Failed to validate connections: ' + data.error);
            }
        })
        .catch(error => {
            hideValidationProgress();
            addValidationLog('error', 'BULK_VALIDATION_ERROR', `Bulk validation error: ${error.message}`);
            showError('Error validating connections: ' + error.message);
        });
    }
    
    // Legacy function for manual validation (calls the new function)
    function validateAllConnections() {
        validateAllConnectionsWithLogs();
    }
    
    // Update connection statuses in UI
    function updateConnectionStatuses(results) {
        Object.entries(results).forEach(([connName, result]) => {
            const statusElement = document.getElementById(`status-${connName}`);
            const timeElement = document.getElementById(`time-${connName}`);
            
            if (result.success) {
                statusElement.className = 'badge bg-success';
                statusElement.innerHTML = '<i class="fas fa-check me-1"></i>Valid';
                timeElement.textContent = `${result.response_time.toFixed(2)}s`;
                connectionStatuses[connName] = 'valid';
            } else {
                statusElement.className = 'badge bg-danger';
                statusElement.innerHTML = '<i class="fas fa-times me-1"></i>Invalid';
                statusElement.title = result.error;
                timeElement.textContent = 'Failed';
                connectionStatuses[connName] = 'invalid';
            }
        });
    }
    
    // Test single connection with logging
    function testSingleConnection(connectionName) {
        const statusElement = document.getElementById(`status-${connectionName}`);
        const timeElement = document.getElementById(`time-${connectionName}`);
        
        addValidationLog('info', connectionName, 'Starting individual connection test...');
        
        statusElement.className = 'badge bg-info';
        statusElement.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Testing...';
        timeElement.textContent = '-';
        
        fetch(`/api/connections/${connectionName}/test-detailed`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                statusElement.className = 'badge bg-success';
                statusElement.innerHTML = '<i class="fas fa-check me-1"></i>Valid';
                timeElement.textContent = `${data.response_time.toFixed(2)}s`;
                
                addValidationLog('success', connectionName, 
                    `Individual test successful. Response time: ${data.response_time.toFixed(2)}s, Server info: ${data.server_info || 'N/A'}, Connection method: ${data.connection_method || 'Default'}`);
                showSuccess(`Connection "${connectionName}" is valid`);
            } else {
                statusElement.className = 'badge bg-danger';
                statusElement.innerHTML = '<i class="fas fa-times me-1"></i>Invalid';
                statusElement.title = data.error;
                timeElement.textContent = 'Failed';
                
                addValidationLog('error', connectionName, 
                    `Individual test failed: ${data.error}. Error code: ${data.error_code || 'N/A'}, Error details: ${data.error_details || 'No additional details'}, Suggested fix: ${data.suggested_fix || 'Check connection parameters'}`);
                showError(`Connection "${connectionName}" failed: ${data.error}`);
            }
        })
        .catch(error => {
            statusElement.className = 'badge bg-danger';
            statusElement.innerHTML = '<i class="fas fa-exclamation me-1"></i>Error';
            timeElement.textContent = 'Error';
            
            addValidationLog('error', connectionName, `Individual test error: ${error.message}`);
            showError('Error testing connection: ' + error.message);
        });
    }
    
    // Validation log management
    let validationLogs = [];
    
    function addValidationLog(level, connection, message) {
        const timestamp = new Date().toLocaleString();
        const logEntry = {
            timestamp: timestamp,
            level: level,
            connection: connection,
            message: message,
            id: Date.now() + Math.random()
        };
        
        validationLogs.unshift(logEntry); // Add to beginning
        
        // Keep only last 100 logs
        if (validationLogs.length > 100) {
            validationLogs = validationLogs.slice(0, 100);
        }
        
        updateValidationLogsDisplay();
    }
    
    function updateValidationLogsDisplay() {
        const logsContainer = document.getElementById('validation-logs');
        const logCount = document.getElementById('log-count');
        
        logCount.textContent = `${validationLogs.length} entries`;
        
        if (validationLogs.length === 0) {
            logsContainer.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Validation logs will appear here when connections are tested
                </div>
            `;
            return;
        }
        
        const logsHtml = validationLogs.map(log => {
            const levelClass = {
                'success': 'text-success',
                'error': 'text-danger',
                'warning': 'text-warning',
                'info': 'text-info'
            }[log.level] || 'text-muted';
            
            const levelIcon = {
                'success': 'fas fa-check-circle',
                'error': 'fas fa-exclamation-circle',
                'warning': 'fas fa-exclamation-triangle',
                'info': 'fas fa-info-circle'
            }[log.level] || 'fas fa-circle';
            
            return `
                <div class="log-entry border-bottom py-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-1">
                                <i class="${levelIcon} ${levelClass} me-2"></i>
                                <strong class="me-2">${log.connection}</strong>
                                <small class="text-muted">${log.timestamp}</small>
                            </div>
                            <div class="log-message">
                                ${log.message}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        logsContainer.innerHTML = `
            <div class="validation-logs-content" style="max-height: 400px; overflow-y: auto;">
                ${logsHtml}
            </div>
        `;
    }
    
    function clearValidationLogs() {
        if (confirm('Clear all validation logs?')) {
            validationLogs = [];
            updateValidationLogsDisplay();
            showSuccess('Validation logs cleared');
        }
    }
    
    function exportValidationLogs() {
        if (validationLogs.length === 0) {
            showError('No logs to export');
            return;
        }
        
        const csvContent = [
            ['Timestamp', 'Level', 'Connection', 'Message'],
            ...validationLogs.map(log => [log.timestamp, log.level, log.connection, log.message])
        ].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `connection-validation-logs-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showSuccess('Validation logs exported successfully');
    }
    
    function showValidationProgress() {
        // Add a progress indicator to the validation logs section
        const logsContainer = document.getElementById('validation-logs');
        logsContainer.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Validating connections...</span>
                </div>
                <div class="mt-2">Validating all connections...</div>
            </div>
        `;
    }
    
    function hideValidationProgress() {
        updateValidationLogsDisplay();
    }
    
    // Test connection form
    function testConnectionForm() {
        const server = document.getElementById('connServer').value;
        const port = document.getElementById('connPort').value;
        const database = document.getElementById('connDatabase').value;
        const authType = document.getElementById('connAuth').value;
        const username = document.getElementById('connUsername').value;
        const password = document.getElementById('connPassword').value;
        
        if (!server || !database) {
            showError('Server and database are required');
            return;
        }
        
        if (authType === 'sql' && (!username || !password)) {
            showError('Username and password are required for SQL authentication');
            return;
        }
        
        showLoading();
        
        const connectionData = {
            server: server,
            port: parseInt(port),
            database: database,
            auth_type: authType,
            username: authType === 'sql' ? username : null,
            password: authType === 'sql' ? password : null
        };
        
        fetch('/api/test-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(connectionData)
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showSuccess(`Connection test successful! Response time: ${data.response_time.toFixed(2)}s`);
            } else {
                showError(`Connection test failed: ${data.error}`);
            }
        })
        .catch(error => {
            hideLoading();
            showError('Error testing connection: ' + error.message);
        });
    }
    
    // Save connection
    function saveConnection() {
        const name = document.getElementById('connName').value;
        const description = document.getElementById('connDescription').value;
        const server = document.getElementById('connServer').value;
        const port = document.getElementById('connPort').value;
        const database = document.getElementById('connDatabase').value;
        const authType = document.getElementById('connAuth').value;
        const username = document.getElementById('connUsername').value;
        const password = document.getElementById('connPassword').value;
        
        if (!name || !server || !database) {
            showError('Connection name, server, and database are required');
            return;
        }
        
        if (authType === 'sql' && (!username || !password)) {
            showError('Username and password are required for SQL authentication');
            return;
        }
        
        showLoading();
        
        const connectionData = {
            name: name,
            description: description,
            server: server,
            port: parseInt(port),
            database: database,
            auth_type: authType,
            username: authType === 'sql' ? username : null,
            password: authType === 'sql' ? password : null
        };
        
        fetch('/api/connections', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(connectionData)
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showSuccess('Connection saved successfully!');
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('connectionModal'));
                modal.hide();
                // Reset form
                document.getElementById('connectionForm').reset();
                // Reload connections
                loadConnections();
            } else {
                showError(`Failed to save connection: ${data.error}`);
            }
        })
        .catch(error => {
            hideLoading();
            showError('Error saving connection: ' + error.message);
        });
    }
    
    // Delete connection
    function deleteConnection(connectionName) {
        if (!confirm(`Are you sure you want to delete connection "${connectionName}"?`)) {
            return;
        }
        
        fetch(`/api/connections/${connectionName}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess(`Connection "${connectionName}" deleted successfully`);
                loadConnections();
            } else {
                showError(`Failed to delete connection: ${data.error}`);
            }
        })
        .catch(error => {
            showError('Error deleting connection: ' + error.message);
        });
    }
    
    // Check system database status
    function checkSystemDatabaseStatus() {
        fetch('/api/system/database-status')
            .then(response => response.json())
            .then(data => {
                const statusElement = document.getElementById('system-db-status');
                if (data.success && data.connected) {
                    statusElement.className = 'badge bg-success ms-2';
                    statusElement.textContent = `${data.database} (${data.response_time.toFixed(2)}s)`;
                } else {
                    statusElement.className = 'badge bg-danger ms-2';
                    statusElement.textContent = 'Disconnected';
                }
            })
            .catch(error => {
                const statusElement = document.getElementById('system-db-status');
                statusElement.className = 'badge bg-warning ms-2';
                statusElement.textContent = 'Unknown';
            });
    }
    
    // Utility functions
    function showElement(id) {
        document.getElementById(id).style.display = 'block';
    }
    
    function hideElement(id) {
        document.getElementById(id).style.display = 'none';
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Check system database status only once on page load for connections page
        checkSystemDatabaseStatus();
        loadConnections();
        
        // Don't auto-refresh system status - let user trigger it manually
        // The status check is expensive and should be on-demand
        
        // Make system database status clickable for manual refresh
        const systemStatusElement = document.getElementById('system-db-status');
        if (systemStatusElement) {
            systemStatusElement.style.cursor = 'pointer';
            systemStatusElement.title = 'Click to refresh system database status';
            systemStatusElement.onclick = function() {
                checkSystemDatabaseStatus();
            };
        }
    });
</script>
{% endblock %}