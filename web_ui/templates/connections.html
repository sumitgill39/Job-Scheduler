{% extends "base.html" %}

{% block title %}Database Connections - Windows Job Scheduler{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-body py-2">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-database me-2 text-primary"></i>
                            <span class="fw-bold">System Database:</span>
                            <span id="system-db-status" class="badge bg-secondary ms-2">Checking...</span>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="loadConnections()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#connectionModal">
                            <i class="fas fa-plus me-1"></i>New Connection
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>
                    Database Connections
                    <span id="connection-count" class="badge bg-secondary ms-2">0</span>
                </h5>
            </div>
            <div class="card-body">
                <!-- Loading indicator -->
                <div id="loading-connections" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading connections...</span>
                    </div>
                    <div class="mt-2">Loading connections from database...</div>
                </div>
                
                <!-- Connections table -->
                <div id="connections-container">
                    <div class="table-responsive">
                        <table class="table table-hover connection-table-optimized" id="connections-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Server</th>
                                    <th>Database</th>
                                    <th>Authentication</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="connections-tbody">
                                <!-- Connections will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Empty state -->
                <div id="empty-state" class="text-center py-5" style="display: none;">
                    <i class="fas fa-database fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No Database Connections Found</h4>
                    <p class="text-muted mb-4">Get started by creating your first database connection.</p>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#connectionModal">
                        <i class="fas fa-plus me-1"></i>Create First Connection
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- New Connection Modal -->
<div class="modal fade" id="connectionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Create New Database Connection
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="connectionForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="connName" class="form-label">Connection Name *</label>
                                <input type="text" class="form-control" id="connName" required>
                                <div class="form-text">Unique name for this connection</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="connDescription" class="form-label">Description</label>
                                <input type="text" class="form-control" id="connDescription">
                                <div class="form-text">Optional description</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="connServer" class="form-label">Server Name/IP *</label>
                                <input type="text" class="form-control" id="connServer" required
                                       placeholder="e.g., localhost, 192.168.1.100, SERVER\INSTANCE">
                                <div class="form-text">Server name, IP address, or named instance</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="connPort" class="form-label">Port</label>
                                <input type="number" class="form-control" id="connPort" value="1433" min="1" max="65535">
                                <div class="form-text">Default: 1433</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="connDatabase" class="form-label">Database Name *</label>
                                <input type="text" class="form-control" id="connDatabase" required>
                                <div class="form-text">Target database name</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="connAuth" class="form-label">Authentication</label>
                                <select class="form-select" id="connAuth">
                                    <option value="sql" selected>SQL Server Authentication</option>
                                    <option value="windows">Windows Authentication</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SQL Authentication Section -->
                    <div id="connSqlAuth" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="connUsername" class="form-label">Username *</label>
                                    <input type="text" class="form-control" id="connUsername">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="connPassword" class="form-label">Password *</label>
                                    <input type="password" class="form-control" id="connPassword">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="testConnectionForm()">
                    <i class="fas fa-plug me-1"></i>Test Connection
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveConnection()">
                    <i class="fas fa-save me-1"></i>Save Connection
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.connection-table-optimized {
    table-layout: fixed;
}

.connection-table-optimized th:nth-child(1) { width: 22%; }
.connection-table-optimized th:nth-child(2) { width: 23%; }
.connection-table-optimized th:nth-child(3) { width: 20%; }
.connection-table-optimized th:nth-child(4) { width: 15%; }
.connection-table-optimized th:nth-child(5) { width: 20%; }

.fast-loading-indicator {
    border-left: 4px solid #007bff;
    background: #e7f3ff;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 4px;
}
</style>
{% endblock %}

{% block scripts %}
<script>
    
    // Authentication type handling
    document.getElementById('connAuth').addEventListener('change', function() {
        const sqlAuthSection = document.getElementById('connSqlAuth');
        if (this.value === 'sql') {
            sqlAuthSection.style.display = 'block';
            document.getElementById('connUsername').required = true;
            document.getElementById('connPassword').required = true;
        } else {
            sqlAuthSection.style.display = 'none';
            document.getElementById('connUsername').required = false;
            document.getElementById('connPassword').required = false;
        }
    });
    
    // Prevent multiple simultaneous requests
    let loadingConnections = false;
    
    // Load connections from database (optimized to prevent race conditions)
    function loadConnections() {
        // Prevent multiple simultaneous load requests
        if (loadingConnections) {
            console.log('[CONNECTIONS] Load already in progress, skipping...');
            return;
        }
        
        loadingConnections = true;
        showElement('loading-connections');
        hideElement('connections-container');
        hideElement('empty-state');
        
        // Add fast loading indicator
        const loadingDiv = document.getElementById('loading-connections');
        loadingDiv.innerHTML = `
            <div class="fast-loading-indicator">
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <strong>Fast Loading:</strong>
                    <span class="ms-2">Loading connections without testing (validation will happen automatically)</span>
                </div>
            </div>
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading connections...</span>
                </div>
                <div class="mt-2">Loading connections from database...</div>
            </div>
        `;
        
        // Use optimized endpoint with cache to prevent race conditions
        fetch('/api/connections?fast=true')
            .then(response => response.json())
            .then(data => {
                loadingConnections = false;
                hideElement('loading-connections');
                
                if (data.success && data.connections && data.connections.length > 0) {
                    displayConnections(data.connections);
                    showElement('connections-container');
                } else {
                    showElement('empty-state');
                }
            })
            .catch(error => {
                console.error('Error loading connections:', error);
                loadingConnections = false;
                hideElement('loading-connections');
                showError('Failed to load connections from database');
                showElement('empty-state');
            });
    }
    
    // Display connections in table
    function displayConnections(connections) {
        const tbody = document.getElementById('connections-tbody');
        tbody.innerHTML = '';
        
        document.getElementById('connection-count').textContent = connections.length;
        
        connections.forEach(conn => {
            const row = createConnectionRow(conn);
            tbody.appendChild(row);
        });
    }
    
    // Create table row for connection
    function createConnectionRow(conn) {
        const row = document.createElement('tr');
        row.id = `conn-row-${conn.name}`;
        
        row.innerHTML = `
            <td>
                <strong>${conn.name}</strong>
                ${conn.description ? `<br><small class="text-muted">${conn.description}</small>` : ''}
            </td>
            <td>${conn.server}${conn.port && conn.port != 1433 ? ':' + conn.port : ''}</td>
            <td>${conn.database}</td>
            <td>${conn.auth_type}</td>
            <td>
                <button type="button" class="btn btn-sm btn-outline-success me-1"
                        onclick="validateConnection('${conn.connection_id}', '${conn.name}')"
                        data-bs-toggle="tooltip" title="Validate Connection">
                    <i class="fas fa-check-circle me-1"></i>Validate
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger"
                        onclick="deleteConnection('${conn.name}')"
                        data-bs-toggle="tooltip" title="Delete Connection">
                    <i class="fas fa-trash me-1"></i>Delete
                </button>
            </td>
        `;
        
        return row;
    }
    
    // Test connection form
    function testConnectionForm() {
        const server = document.getElementById('connServer').value;
        const port = document.getElementById('connPort').value;
        const database = document.getElementById('connDatabase').value;
        const authType = document.getElementById('connAuth').value;
        const username = document.getElementById('connUsername').value;
        const password = document.getElementById('connPassword').value;
        
        if (!server || !database) {
            showError('Server and database are required');
            return;
        }
        
        if (authType === 'sql' && (!username || !password)) {
            showError('Username and password are required for SQL authentication');
            return;
        }
        
        showLoading();
        
        const connectionData = {
            server: server,
            port: parseInt(port),
            database: database,
            auth_type: authType,
            username: authType === 'sql' ? username : null,
            password: authType === 'sql' ? password : null
        };
        
        fetch('/api/test-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(connectionData)
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showSuccess(`Connection test successful! Response time: ${data.response_time.toFixed(2)}s`);
            } else {
                showError(`Connection test failed: ${data.error}`);
            }
        })
        .catch(error => {
            hideLoading();
            showError('Error testing connection: ' + error.message);
        });
    }
    
    // Save connection
    function saveConnection() {
        const name = document.getElementById('connName').value;
        const description = document.getElementById('connDescription').value;
        const server = document.getElementById('connServer').value;
        const port = document.getElementById('connPort').value;
        const database = document.getElementById('connDatabase').value;
        const authType = document.getElementById('connAuth').value;
        const username = document.getElementById('connUsername').value;
        const password = document.getElementById('connPassword').value;
        
        if (!name || !server || !database) {
            showError('Connection name, server, and database are required');
            return;
        }
        
        if (authType === 'sql' && (!username || !password)) {
            showError('Username and password are required for SQL authentication');
            return;
        }
        
        showLoading();
        
        const connectionData = {
            name: name,
            description: description,
            server: server,
            port: parseInt(port),
            database: database,
            auth_type: authType,
            username: authType === 'sql' ? username : null,
            password: authType === 'sql' ? password : null
        };
        
        fetch('/api/connections', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(connectionData)
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showSuccess('Connection saved successfully!');
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('connectionModal'));
                modal.hide();
                // Reset form
                document.getElementById('connectionForm').reset();
                // Reload connections
                loadConnections();
            } else {
                showError(`Failed to save connection: ${data.error}`);
            }
        })
        .catch(error => {
            hideLoading();
            showError('Error saving connection: ' + error.message);
        });
    }
    
    // Validate connection
    function validateConnection(connectionId, connectionName) {
        showLoading(`Validating connection "${connectionName}"...`);
        
        fetch(`/api/connections/${connectionId}/validate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showSuccess(`Connection "${connectionName}" validated successfully! Response time: ${data.response_time}ms`);
            } else {
                showError(`Connection validation failed: ${data.error}`);
            }
        })
        .catch(error => {
            hideLoading();
            showError('Error validating connection: ' + error.message);
        });
    }
    
    // Delete connection
    function deleteConnection(connectionName) {
        if (!confirm(`Are you sure you want to delete connection "${connectionName}"?`)) {
            return;
        }
        
        fetch(`/api/connections/${connectionName}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess(`Connection "${connectionName}" deleted successfully`);
                loadConnections();
            } else {
                showError(`Failed to delete connection: ${data.error}`);
            }
        })
        .catch(error => {
            showError('Error deleting connection: ' + error.message);
        });
    }
    
    // Check system database status
    function checkSystemDatabaseStatus() {
        fetch('/api/system/database-status')
            .then(response => response.json())
            .then(data => {
                const statusElement = document.getElementById('system-db-status');
                if (data.success && data.connected) {
                    statusElement.className = 'badge bg-success ms-2';
                    statusElement.textContent = `${data.database} (${data.response_time.toFixed(2)}s)`;
                } else {
                    statusElement.className = 'badge bg-danger ms-2';
                    statusElement.textContent = 'Disconnected';
                }
            })
            .catch(error => {
                const statusElement = document.getElementById('system-db-status');
                statusElement.className = 'badge bg-warning ms-2';
                statusElement.textContent = 'Unknown';
            });
    }
    
    // Utility functions
    function showElement(id) {
        document.getElementById(id).style.display = 'block';
    }
    
    function hideElement(id) {
        document.getElementById(id).style.display = 'none';
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Check system database status only once on page load for connections page
        checkSystemDatabaseStatus();
        loadConnections();
        
        // Initialize SQL authentication fields as visible (since SQL is now default)
        const sqlAuthSection = document.getElementById('connSqlAuth');
        const authSelect = document.getElementById('connAuth');
        if (sqlAuthSection && authSelect && authSelect.value === 'sql') {
            sqlAuthSection.style.display = 'block';
            document.getElementById('connUsername').required = true;
            document.getElementById('connPassword').required = true;
        }
        
        // Don't auto-refresh system status - let user trigger it manually
        // The status check is expensive and should be on-demand
        
        // Make system database status clickable for manual refresh
        const systemStatusElement = document.getElementById('system-db-status');
        if (systemStatusElement) {
            systemStatusElement.style.cursor = 'pointer';
            systemStatusElement.title = 'Click to refresh system database status';
            systemStatusElement.onclick = function() {
                checkSystemDatabaseStatus();
            };
        }
    });
</script>
{% endblock %}