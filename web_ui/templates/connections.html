{% extends "base.html" %}

{% block title %}Database Connections - Job Scheduler{% endblock %}

{% block extra_css %}
<style>
    .connection-card {
        transition: all 0.3s ease;
        border-left: 4px solid #dee2e6;
    }
    
    .connection-card.online {
        border-left-color: #28a745;
    }
    
    .connection-card.offline {
        border-left-color: #dc3545;
    }
    
    .connection-card.unknown {
        border-left-color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-database me-2"></i>Database Connections</h2>
                <p class="text-muted">Manage SQL Server connections for your jobs</p>
            </div>
            <div>
                <button type="button" class="btn btn-outline-secondary me-2" id="refreshBtn">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newConnectionModal">
                    <i class="fas fa-plus me-1"></i>New Connection
                </button>
            </div>
        </div>
        
        <!-- Connections Grid -->
        <div id="connectionsGrid" class="row">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadConnections();
    
    // Add refresh button handler
    document.getElementById('refreshBtn').addEventListener('click', loadConnections);
});

function loadConnections() {
    const grid = document.getElementById('connectionsGrid');
    
    fetch('/api/connections')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.connections) {
                renderConnections(data.connections);
            } else {
                grid.innerHTML = '<div class="col-12"><div class="alert alert-warning">No connections found.</div></div>';
            }
        })
        .catch(error => {
            console.error('Error loading connections:', error);
            grid.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger">
                        Failed to load connections: ${error.message}
                    </div>
                </div>
            `;
        });
}

function renderConnections(connections) {
    const grid = document.getElementById('connectionsGrid');
    
    grid.innerHTML = connections.map(conn => `
        <div class="col-xl-4 col-lg-6 col-md-6 mb-4">
            <div class="card connection-card ${conn.status || 'unknown'}">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-database me-2"></i>${conn.name}
                    </h5>
                    <div class="mb-3">
                        <small class="text-muted">
                            <i class="fas fa-server me-1"></i>${conn.server}:${conn.port}
                        </small><br>
                        <small class="text-muted">
                            <i class="fas fa-database me-1"></i>${conn.database}
                        </small><br>
                        <small class="text-muted">
                            <i class="fas fa-user me-1"></i>${conn.username}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}
</script>
{% endblock %}

{% endblock %}