{% extends "base.html" %}

{% block title %}Admin Panel - Windows Job Scheduler{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-cog me-2"></i>Administration Panel</h1>
    <div>
        <button class="btn btn-outline-info" onclick="refreshSystemStats()">
            <i class="fas fa-sync-alt me-1"></i>Refresh Stats
        </button>
    </div>
</div>

<!-- System Overview -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-tasks fa-2x text-primary mb-2"></i>
                <h5 class="card-title" id="totalJobs">-</h5>
                <p class="card-text">Total Jobs</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-play fa-2x text-success mb-2"></i>
                <h5 class="card-title" id="activeJobs">-</h5>
                <p class="card-text">Active Jobs</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-database fa-2x text-info mb-2"></i>
                <h5 class="card-title" id="totalConnections">-</h5>
                <p class="card-text">DB Connections</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-users fa-2x text-warning mb-2"></i>
                <h5 class="card-title" id="activeSessions">-</h5>
                <p class="card-text">Active Sessions</p>
            </div>
        </div>
    </div>
</div>

<!-- Admin Navigation -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Admin Dashboard</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="list-group">
                            <a href="#system-management" class="list-group-item list-group-item-action active" onclick="showSection('system-management')">
                                <i class="fas fa-server me-2"></i>System Management
                            </a>
                            <a href="/admin/job-queue" class="list-group-item list-group-item-action">
                                <i class="fas fa-stream me-2"></i>Job Queue Monitor
                            </a>
                            <a href="/executions/history" class="list-group-item list-group-item-action">
                                <i class="fas fa-history me-2"></i>Execution History
                            </a>
                            <a href="#system-workflow" class="list-group-item list-group-item-action" onclick="showSection('system-workflow')">
                                <i class="fas fa-project-diagram me-2"></i>System Workflow
                            </a>
                            <a href="#system-monitoring" class="list-group-item list-group-item-action" onclick="showSection('system-monitoring')">
                                <i class="fas fa-chart-line me-2"></i>System Monitoring
                            </a>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div id="admin-content">
                            <!-- Content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row" id="legacy-admin-content">
    <div class="col-lg-8">
        <!-- System Management -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-server me-2"></i>System Management
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Scheduler Control</h6>
                        <div class="btn-group-vertical w-100 mb-3" role="group">
                            <button class="btn btn-outline-success" onclick="startScheduler()">
                                <i class="fas fa-play me-2"></i>Start Scheduler
                            </button>
                            <button class="btn btn-outline-warning" onclick="pauseScheduler()">
                                <i class="fas fa-pause me-2"></i>Pause Scheduler
                            </button>
                            <button class="btn btn-outline-danger" onclick="stopScheduler()">
                                <i class="fas fa-stop me-2"></i>Stop Scheduler
                            </button>
                        </div>
                        
                        <h6>Database Management</h6>
                        <div class="btn-group-vertical w-100" role="group">
                            <button class="btn btn-outline-info" onclick="testAllConnections()">
                                <i class="fas fa-plug me-2"></i>Test All Connections
                            </button>
                            <button class="btn btn-outline-secondary" onclick="cleanupConnectionPool()">
                                <i class="fas fa-broom me-2"></i>Cleanup Connection Pool
                            </button>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h6>Application Control</h6>
                        <div class="btn-group-vertical w-100 mb-3" role="group">
                            <button class="btn btn-outline-info" onclick="viewSystemLogs()">
                                <i class="fas fa-file-alt me-2"></i>View System Logs
                            </button>
                            <button class="btn btn-outline-warning" onclick="clearSystemLogs()">
                                <i class="fas fa-trash me-2"></i>Clear Logs
                            </button>
                            <button class="btn btn-outline-primary" onclick="exportConfiguration()">
                                <i class="fas fa-download me-2"></i>Export Config
                            </button>
                        </div>
                        
                        <h6>Emergency Controls</h6>
                        <div class="btn-group-vertical w-100" role="group">
                            <button class="btn btn-outline-warning" onclick="killAllRunningJobs()">
                                <i class="fas fa-stop-circle me-2"></i>Kill All Running Jobs
                            </button>
                            <button class="btn btn-outline-danger" onclick="emergencyShutdown()">
                                <i class="fas fa-power-off me-2"></i>Emergency Shutdown
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Sessions -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-users me-2"></i>Active User Sessions
                </h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="refreshActiveSessions()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
            <div class="card-body">
                <div id="activeSessionsList" class="table-responsive">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin me-2"></i>Loading sessions...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- System Status -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-heartbeat me-2"></i>System Status
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Scheduler Status:</span>
                        <span id="schedulerStatus" class="badge bg-secondary">Loading...</span>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Database Status:</span>
                        <span id="databaseStatus" class="badge bg-secondary">Loading...</span>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>AD Domain Status:</span>
                        <span id="adStatus" class="badge bg-secondary">Loading...</span>
                    </div>
                </div>
                <div class="mb-0">
                    <div class="d-flex justify-content-between">
                        <span>Uptime:</span>
                        <span id="systemUptime">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Connection Pool Stats -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-swimming-pool me-2"></i>Connection Pool
                </h5>
            </div>
            <div class="card-body">
                <div id="connectionPoolStats">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin me-2"></i>Loading stats...
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activities -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Recent Activities
                </h5>
            </div>
            <div class="card-body">
                <div id="recentActivities">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin me-2"></i>Loading activities...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Logs Modal -->
<div class="modal fade" id="systemLogsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-alt me-2"></i>System Logs
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="row">
                        <div class="col-md-4">
                            <select class="form-select" id="logLevel">
                                <option value="">All Levels</option>
                                <option value="ERROR">ERROR</option>
                                <option value="WARNING">WARNING</option>
                                <option value="INFO">INFO</option>
                                <option value="DEBUG">DEBUG</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <input type="number" class="form-control" id="logLimit" placeholder="Lines (default 100)" value="100">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary" onclick="loadSystemLogs()">
                                <i class="fas fa-sync-alt me-1"></i>Refresh Logs
                            </button>
                        </div>
                    </div>
                </div>
                <div id="systemLogsContent" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: 5px;">
                    <div class="text-center text-muted">
                        Click "Refresh Logs" to load system logs
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load initial data
document.addEventListener('DOMContentLoaded', function() {
    refreshSystemStats();
    refreshActiveSessions();
    loadConnectionPoolStats();
    showSection('system-management'); // Show default section
});

// Admin section management
function showSection(sectionName) {
    // Update active navigation
    document.querySelectorAll('.list-group-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[onclick="showSection('${sectionName}')"]`).classList.add('active');
    
    // Load content based on section
    const contentDiv = document.getElementById('admin-content');
    
    switch(sectionName) {
        case 'system-management':
            contentDiv.innerHTML = getSystemManagementContent();
            break;
        case 'system-workflow':
            contentDiv.innerHTML = getSystemWorkflowContent();
            loadWorkflowStatus();
            break;
        case 'system-monitoring':
            contentDiv.innerHTML = getSystemMonitoringContent();
            break;
        default:
            contentDiv.innerHTML = '<div class="text-muted">Section not found</div>';
    }
    
    // Hide legacy content when using new sections
    document.getElementById('legacy-admin-content').style.display = 'none';
}

function getSystemManagementContent() {
    return `
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">System Management</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Scheduler Control</h6>
                        <div class="btn-group-vertical w-100 mb-3" role="group">
                            <button class="btn btn-outline-success" onclick="startScheduler()">
                                <i class="fas fa-play me-2"></i>Start Scheduler
                            </button>
                            <button class="btn btn-outline-warning" onclick="pauseScheduler()">
                                <i class="fas fa-pause me-2"></i>Pause Scheduler
                            </button>
                            <button class="btn btn-outline-danger" onclick="stopScheduler()">
                                <i class="fas fa-stop me-2"></i>Stop Scheduler
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Database Management</h6>
                        <div class="btn-group-vertical w-100" role="group">
                            <button class="btn btn-outline-info" onclick="testAllConnections()">
                                <i class="fas fa-plug me-2"></i>Test All Connections
                            </button>
                            <button class="btn btn-outline-secondary" onclick="cleanupConnectionPool()">
                                <i class="fas fa-broom me-2"></i>Cleanup Connection Pool
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function getSystemWorkflowContent() {
    return `
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">System Workflow & Component Status</h6>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshWorkflowStatus()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <!-- Frontend -->
                    <div class="col-md-2">
                        <div class="text-center">
                            <div id="workflow-frontend" class="workflow-status mb-2">
                                <i class="fas fa-desktop fa-2x"></i>
                            </div>
                            <h6>Frontend</h6>
                            <small class="text-muted">Web UI</small>
                            <div class="mt-1">
                                <span id="frontend-status" class="badge bg-secondary">Checking...</span>
                            </div>
                        </div>
                    </div>
                    <!-- API Endpoint -->
                    <div class="col-md-2">
                        <div class="text-center">
                            <div id="workflow-api" class="workflow-status mb-2">
                                <i class="fas fa-exchange-alt fa-2x"></i>
                            </div>
                            <h6>API Endpoint</h6>
                            <small class="text-muted">Flask Routes</small>
                            <div class="mt-1">
                                <span id="api-status" class="badge bg-secondary">Checking...</span>
                            </div>
                        </div>
                    </div>
                    <!-- Job Manager -->
                    <div class="col-md-2">
                        <div class="text-center">
                            <div id="workflow-jobmanager" class="workflow-status mb-2">
                                <i class="fas fa-tasks fa-2x"></i>
                            </div>
                            <h6>Job Manager</h6>
                            <small class="text-muted">Job Control</small>
                            <div class="mt-1">
                                <span id="jobmanager-status" class="badge bg-secondary">Checking...</span>
                            </div>
                        </div>
                    </div>
                    <!-- Connection Pool -->
                    <div class="col-md-2">
                        <div class="text-center">
                            <div id="workflow-pool" class="workflow-status mb-2">
                                <i class="fas fa-swimming-pool fa-2x"></i>
                            </div>
                            <h6>Connection Pool</h6>
                            <small class="text-muted">DB Pool</small>
                            <div class="mt-1">
                                <span id="pool-status" class="badge bg-secondary">Checking...</span>
                            </div>
                        </div>
                    </div>
                    <!-- Database -->
                    <div class="col-md-2">
                        <div class="text-center">
                            <div id="workflow-database" class="workflow-status mb-2">
                                <i class="fas fa-database fa-2x"></i>
                            </div>
                            <h6>Database</h6>
                            <small class="text-muted">SQL Server</small>
                            <div class="mt-1">
                                <span id="database-status" class="badge bg-secondary">Checking...</span>
                            </div>
                        </div>
                    </div>
                    <!-- Scheduler -->
                    <div class="col-md-2">
                        <div class="text-center">
                            <div id="workflow-scheduler" class="workflow-status mb-2">
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                            <h6>Scheduler</h6>
                            <small class="text-muted">APScheduler</small>
                            <div class="mt-1">
                                <span id="scheduler-status" class="badge bg-secondary">Checking...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Workflow Flow Diagram -->
                <div class="workflow-flow mb-3">
                    <div class="text-center">
                        <i class="fas fa-arrow-right text-primary mx-2"></i>
                        <span class="text-muted">Request Flow:</span>
                        <i class="fas fa-arrow-right text-primary mx-2"></i>
                    </div>
                    <div class="text-center mt-2">
                        <small class="text-muted">
                            Frontend → API → Job Manager → Connection Pool → Database
                        </small>
                    </div>
                </div>
                
                <!-- Component Details -->
                <div id="workflow-details" class="mt-4">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <style>
        .workflow-status {
            padding: 15px;
            border-radius: 50%;
            background: #f8f9fa;
            display: inline-block;
            transition: all 0.3s ease;
        }
        .workflow-status.status-success {
            background: #d4edda;
            color: #155724;
        }
        .workflow-status.status-warning {
            background: #fff3cd;
            color: #856404;
        }
        .workflow-status.status-danger {
            background: #f8d7da;
            color: #721c24;
        }
        .workflow-flow {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            background: #f8f9fa;
        }
        </style>
    `;
}

function getSystemMonitoringContent() {
    return `
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">System Monitoring</h6>
            </div>
            <div class="card-body">
                <div class="text-center text-muted py-5">
                    <i class="fas fa-chart-line fa-3x mb-3"></i>
                    <h5>System Monitoring</h5>
                    <p>Advanced monitoring features coming soon...</p>
                </div>
            </div>
        </div>
    `;
}

// Workflow status functions
function loadWorkflowStatus() {
    refreshWorkflowStatus();
}

function refreshWorkflowStatus() {
    // Test each component
    Promise.all([
        testFrontendStatus(),
        testApiStatus(),
        testJobManagerStatus(),
        testConnectionPoolStatus(),
        testDatabaseStatus(),
        testSchedulerStatus()
    ]).then(() => {
        updateWorkflowDetails();
    });
}

function testFrontendStatus() {
    // Frontend is always working if we can execute this JavaScript
    updateWorkflowComponent('frontend', true, 'Online');
    return Promise.resolve();
}

function testApiStatus() {
    return fetch('/api/status')
        .then(response => response.ok)
        .then(success => {
            updateWorkflowComponent('api', success, success ? 'Online' : 'Offline');
        })
        .catch(() => {
            updateWorkflowComponent('api', false, 'Offline');
        });
}

function testJobManagerStatus() {
    return fetch('/api/jobs')
        .then(response => response.json())
        .then(data => {
            const success = data.success !== false;
            updateWorkflowComponent('jobmanager', success, success ? 'Online' : 'Offline');
        })
        .catch(() => {
            updateWorkflowComponent('jobmanager', false, 'Offline');
        });
}

function testConnectionPoolStatus() {
    return fetch('/api/system/database-stats')
        .then(response => response.json())
        .then(data => {
            const success = data.success;
            const status = success ? `SQLAlchemy Pool: ${data.database_stats.pool_size || 0} size` : 'Offline';
            updateWorkflowComponent('pool', success, status);
        })
        .catch(() => {
            updateWorkflowComponent('pool', false, 'Offline');
        });
}

function testDatabaseStatus() {
    return fetch('/api/system/database-status')
        .then(response => response.json())
        .then(data => {
            const success = data.success && data.connected;
            const status = success ? `Connected (${data.response_time.toFixed(2)}s)` : 'Disconnected';
            updateWorkflowComponent('database', success, status);
        })
        .catch(() => {
            updateWorkflowComponent('database', false, 'Disconnected');
        });
}

function testSchedulerStatus() {
    return fetch('/api/admin/scheduler-status')
        .then(response => response.json())
        .then(data => {
            const success = data.success;
            updateWorkflowComponent('scheduler', success, data.status || 'Unknown');
        })
        .catch(() => {
            updateWorkflowComponent('scheduler', false, 'Offline');
        });
}

function updateWorkflowComponent(component, success, statusText) {
    const statusClass = success ? 'status-success' : 'status-danger';
    const badgeClass = success ? 'bg-success' : 'bg-danger';
    
    // Update the visual component
    const componentDiv = document.getElementById(`workflow-${component}`);
    if (componentDiv) {
        componentDiv.className = `workflow-status mb-2 ${statusClass}`;
    }
    
    // Update the status badge
    const statusBadge = document.getElementById(`${component}-status`);
    if (statusBadge) {
        statusBadge.className = `badge ${badgeClass}`;
        statusBadge.textContent = statusText;
    }
}

function updateWorkflowDetails() {
    const detailsDiv = document.getElementById('workflow-details');
    if (detailsDiv) {
        detailsDiv.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Component Health Check Complete</strong><br>
                All system components have been tested. Green indicates healthy, red indicates issues.
            </div>
        `;
    }
}

function refreshSystemStats() {
    // Load system statistics
    Promise.all([
        fetch('/api/admin/system-stats'),
        fetch('/api/admin/scheduler-status'),
        fetch('/api/system/database-status'),
        fetch('/api/auth/test-domain')
    ]).then(responses => {
        return Promise.all(responses.map(r => r.json()));
    }).then(([sysStats, scheduler, database, ad]) => {
        // Update overview cards
        if (sysStats.success) {
            document.getElementById('totalJobs').textContent = sysStats.stats.total_jobs || '0';
            document.getElementById('activeJobs').textContent = sysStats.stats.active_jobs || '0';
            document.getElementById('totalConnections').textContent = sysStats.stats.total_connections || '0';
            document.getElementById('activeSessions').textContent = sysStats.stats.active_sessions || '0';
            document.getElementById('systemUptime').textContent = sysStats.stats.uptime || '-';
        }
        
        // Update status indicators
        updateStatusBadge('schedulerStatus', scheduler.success, scheduler.status || 'Unknown');
        updateStatusBadge('databaseStatus', database.success, database.connected ? 'Connected' : 'Disconnected');
        updateStatusBadge('adStatus', ad.success && ad.domain_test.reachable_controllers > 0, 
                         ad.success ? `${ad.domain_test.reachable_controllers}/${ad.domain_test.total_controllers} DCs` : 'Offline');
    }).catch(error => {
        console.error('Error loading system stats:', error);
        showError('Failed to load system statistics');
    });
}

function updateStatusBadge(elementId, success, text) {
    const element = document.getElementById(elementId);
    element.textContent = text;
    element.className = `badge bg-${success ? 'success' : 'danger'}`;
}

function loadConnectionPoolStats() {
    fetch('/api/system/database-stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const stats = data.database_stats;
                document.getElementById('connectionPoolStats').innerHTML = `
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>SQLAlchemy Pool Size:</span>
                            <strong>${stats.pool_size || 0}</strong>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Checked Out:</span>
                            <strong>${stats.checked_out || 0}</strong>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Overflow:</span>
                            <strong>${stats.overflow || 0}</strong>
                        </div>
                    </div>
                    <div class="mb-0">
                        <div class="d-flex justify-content-between">
                            <span>Pool Status:</span>
                            <span class="badge bg-success">SQLAlchemy</span>
                        </div>
                    </div>
                `;
            }
        })
        .catch(error => {
            document.getElementById('connectionPoolStats').innerHTML = '<div class="text-danger">Failed to load SQLAlchemy stats</div>';
        });
}

function refreshActiveSessions() {
    fetch('/api/admin/active-sessions')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.sessions.length > 0) {
                let html = '<table class="table table-sm"><thead><tr><th>User</th><th>Login Time</th><th>Idle</th><th>Actions</th></tr></thead><tbody>';
                data.sessions.forEach(session => {
                    html += `
                        <tr>
                            <td>
                                <strong>${session.username}</strong><br>
                                <small class="text-muted">${session.client_ip}</small>
                            </td>
                            <td>${session.login_time}</td>
                            <td>${session.idle_minutes}m</td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger" onclick="terminateSession('${session.session_id}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
                document.getElementById('activeSessionsList').innerHTML = html;
            } else {
                document.getElementById('activeSessionsList').innerHTML = '<div class="text-muted">No active sessions</div>';
            }
        })
        .catch(error => {
            document.getElementById('activeSessionsList').innerHTML = '<div class="text-danger">Failed to load sessions</div>';
        });
}

// System Control Functions
function startScheduler() {
    if (confirm('Start the job scheduler?')) {
        executeAdminCommand('/api/admin/scheduler/start', 'Starting scheduler...');
    }
}

function pauseScheduler() {
    if (confirm('Pause the job scheduler? Running jobs will continue but no new jobs will start.')) {
        executeAdminCommand('/api/admin/scheduler/pause', 'Pausing scheduler...');
    }
}

function stopScheduler() {
    if (confirm('Stop the job scheduler? This will stop all running jobs.')) {
        executeAdminCommand('/api/admin/scheduler/stop', 'Stopping scheduler...');
    }
}

function testAllConnections() {
    showLoading();
    fetch('/api/connections/validate-all', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showSuccess(`Connection test completed: ${data.valid_connections}/${data.total_connections} valid`);
                refreshSystemStats();
            } else {
                showError(data.error || 'Connection test failed');
            }
        })
        .catch(error => {
            hideLoading();
            showError('Error testing connections: ' + error.message);
        });
}

function cleanupConnectionPool() {
    if (confirm('Check database health and connectivity?')) {
        executeAdminCommand('/api/system/database-health', 'Checking SQLAlchemy database health...');
    }
}

function killAllRunningJobs() {
    if (confirm('[WARNING] CAUTION: This will forcibly terminate all running jobs. Are you sure?')) {
        executeAdminCommand('/api/admin/kill-all-jobs', 'Terminating all running jobs...');
    }
}

function emergencyShutdown() {
    if (confirm('[WARNING] EMERGENCY SHUTDOWN: This will immediately stop the entire application. Are you sure?')) {
        if (confirm('This action cannot be undone and may cause data loss. Proceed?')) {
            executeAdminCommand('/api/admin/emergency-shutdown', 'Initiating emergency shutdown...');
        }
    }
}

function executeAdminCommand(endpoint, message) {
    showLoading();
    showInfo(message);
    
    fetch(endpoint, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showSuccess(data.message || 'Command executed successfully');
                setTimeout(() => refreshSystemStats(), 1000);
            } else {
                showError(data.error || 'Command failed');
            }
        })
        .catch(error => {
            hideLoading();
            showError('Command error: ' + error.message);
        });
}

function viewSystemLogs() {
    document.getElementById('systemLogsModal').querySelector('.modal').show();
    loadSystemLogs();
}

function loadSystemLogs() {
    const level = document.getElementById('logLevel').value;
    const limit = document.getElementById('logLimit').value || 100;
    
    const params = new URLSearchParams();
    if (level) params.append('level', level);
    params.append('limit', limit);
    
    document.getElementById('systemLogsContent').innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading logs...</div>';
    
    fetch(`/api/admin/system-logs?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const logs = data.logs.map(log => 
                    `<div class="log-entry mb-1"><small class="text-muted">${log.timestamp}</small> <span class="badge bg-${getLogLevelClass(log.level)}">${log.level}</span> ${log.message}</div>`
                ).join('');
                document.getElementById('systemLogsContent').innerHTML = logs || '<div class="text-muted">No logs found</div>';
            } else {
                document.getElementById('systemLogsContent').innerHTML = '<div class="text-danger">Failed to load logs</div>';
            }
        })
        .catch(error => {
            document.getElementById('systemLogsContent').innerHTML = '<div class="text-danger">Error loading logs: ' + error.message + '</div>';
        });
}

function getLogLevelClass(level) {
    switch(level) {
        case 'ERROR': return 'danger';
        case 'WARNING': return 'warning';
        case 'INFO': return 'info';
        case 'DEBUG': return 'secondary';
        default: return 'secondary';
    }
}

function clearSystemLogs() {
    if (confirm('Clear all system logs? This action cannot be undone.')) {
        executeAdminCommand('/api/admin/clear-logs', 'Clearing system logs...');
    }
}

function exportConfiguration() {
    window.open('/api/admin/export-config', '_blank');
}

function terminateSession(sessionId) {
    if (confirm('Terminate this user session?')) {
        fetch(`/api/admin/terminate-session/${sessionId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('Session terminated');
                    refreshActiveSessions();
                } else {
                    showError(data.error || 'Failed to terminate session');
                }
            })
            .catch(error => {
                showError('Error terminating session: ' + error.message);
            });
    }
}

// Auto-refresh every 30 seconds
setInterval(() => {
    refreshSystemStats();
    loadConnectionPoolStats();
}, 30000);
</script>
{% endblock %}